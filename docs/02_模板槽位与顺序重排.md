# 02 模板、槽位、档位与顺序重排（参考 Noita/魔法工艺）

## 设计目标
参考《Noita》的魔杖系统与《魔法工艺》的模块化构建，把“玩家自定义”控制在安全可运营的范围内：
- 玩家 **只能重排顺序**（Order）与在每个槽位内 **选择预置档位**（Option）。
- 玩家 **不能更改类型/新增逻辑**：Event、槽位集合、槽位类型都由 Template 固定。
- **与 Noita 的差异**：Noita 允许同一法术重复多次，本设计采用“每个模块只出现一次，但顺序可重排”，更接近《魔法工艺》的“模块组合”逻辑。

## 数据结构（概念）
- `SkillTemplate`
  - `id`
  - `event`：固定事件类型
  - `guards`：模板级硬约束（例如 OnDamaged 必带 ICD）
  - `budgetCap`：预算上限
  - `slots[]`：槽位集合（每个槽位 `type` 固定）
- `Slot`
  - `id`
  - `type`：Condition | Target | Action | Timeline
  - `options[]`：可选档位（2~4 个为宜）
  - `defaultOption`
- `PlayerAssembly`
  - `templateId`
  - `order[]`：槽位 id 的排列（必须与 slots 集合完全相同）
  - `slotOptions{slotId: optionId}`
  - `description?`：自动生成的技能描述（一句话）
  - `isRandom?`：是否为随机生成的武器

## 编译规则（Order → ops）
1. 校验 `order` 是否与模板 `slots` 完全一致（同集合、无重复）
2. 按 `order` 线性生成 `ops[]`：
   - 每个 slot 读取 `slotOptions[slotId]`，找对应 option
3. 聚合预算并校验 <= `budgetCap`
4. 注入 `guards`（玩家不可移除）
5. 输出 `RuntimeIR`（ops + guards + signature）

## 顺序重排的允许范围（必须规则）
- **不允许**：新增/删除 slot
- **不允许**：跨模板拼装（例如把 A 模板的 Action 拿到 B 模板）
- **不允许**：把 slot 的 `type` 改成其他类型
- **允许**：任何 slot 的位置交换，但某些模板可额外限制（例如 Timeline 不允许放到第一个位置，以避免全技能变成纯延迟）

## 5 个 PVE 模板（当前实现版本）
以下为 PVE 验证用的 5 模板，具体字段以配置为准（参见 `configs/templates.js`）。

### 1) 远程投射 `tpl_ranged_proj_v1`（CastConfirm）
槽位集合（示例）：
- `c1` Condition：资源（Mana≥30 / Ammo≥1）
- `c2` Condition：距离（≤12 / ≤18）
- `t1` Target：Line / ConeSmall / ConeWide
- `a1` Action：投射（快弹/穿透）
- `a2` Action：伤害（中/高）
- `a3` Action：减速/易伤
- `tl1` Timeline：无延迟 / 0.25s

典型顺序差异：
- `t1` 放前：先锁定目标再做 `c2` 距离判定（更“锁定技能”）
- `c2` 放前：无目标时距离条件通过，目标选择决定最终命中（更“非锁定”）

### 2) 近战爆发 `tpl_melee_burst_v1`（CastConfirm）
- `c1` 近战距离
- `a1` Dash（无/5m）
- `a2` 伤害形态（扇形高伤 / 直线穿刺）
- `a3` 自身状态（狂暴代价 / 护盾）
- `a4` 控制（击退 / 小眩）
- `tl1` 自代价（硬直/自减速，PVE 可简化）
- `tl2` 后摇（0.2 / 0.4）

顺序差异：
- 先 Dash 再伤害：更易命中但风险更接近怪群
- 先控再打：稳定；先打再控：爆发更强但可能空

### 3) 反击 `tpl_counter_v1`（OnDamaged）
模板级 guards：`ICD=800ms`，`CapPerSecond=2`（不可移除）
- `c1` ProcChance（20%/35%）
- `a1` 脉冲/范围效果（当前简化为一次伤害）
- `a2` 控制（沉默/减速）
- `a3` 追加伤害（轻/中）
- `a4` 自代价（自减速/自定身）
- `tl1` 延迟（0 / 0.15s）

顺序差异：
- 先控后伤：更稳；先伤后控：偏反击爆发

### 4) 地面持续 `tpl_ground_dot_v1`（CastConfirm）
- `c1` Mana≥25
- `t1` 圆形半径（3/4）
- `a1` SpawnAreaDoT（4s/6s）
- `a2` TickDebuff（减速/禁疗）
- `tl1` 延迟（0 / 0.3s）

顺序差异：
- 先 debuff 后 dot：控制更先手；先 dot 后 debuff：更偏伤害回报

### 5) 标记收割 `tpl_mark_exec_v1`（CastConfirm）
（PVE 经济向验证）
- `c1` 目标类型（怪物/任意）
- `t1` 单体目标
- `a1` 上印记
- `a2` 印记奖励（掉落加成表）
- `a3` 轻伤/无伤
- `tl1` 无延迟

顺序差异：
- 先伤害再印记：更难触发奖励（因为可能击杀在印记前）
- 先印记再伤害：更稳定触发奖励（更像“狩猎准备”）

## 推荐的策划配置准则（参考 Noita/魔法工艺）
- **每个模板 6~8 个模块槽位**，避免过长难理解（参考 Noita 的魔杖槽位数）
- **每个槽位 2~4 个档位**，避免“无限微调”（参考 Noita 的法术参数档位）
- 提供至少 2 种“有意义的顺序分歧点”：例如 Target 与 Condition、Debuff 与 Damage、Timeline 前后（参考 Noita 中调整法术顺序影响施法节奏）
- 将高风险能力放在模板级 guard（ICD/Cap/MaxSpawn）里，玩家不可移除（参考 Noita 的魔杖固有属性）
- **参考 Noita 的充能机制**：某些模块可以“充能”后续模块，顺序重排会影响充能效率

