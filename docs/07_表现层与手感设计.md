# 07 表现层与手感设计（主控/施法/怪物具象化）

> 本文定义“看起来像游戏”的关键体验层：主控角色、施法指示器、前摇/后摇、投射物速度与命中反馈，以及怪物的具象化与攻击预警（telegraph）。\n+> 原则：**判定在战斗层（逻辑）**，**表现可预测/可延迟/可降级**，但两者必须共享同一套“技能参数与时间轴”，否则手感会漂。

## 7.1 分层：判定 vs 表现
### 判定层（Authoritative Combat）
决定“是否命中/造成多少伤害/施加什么状态/位移终态”，由逻辑层执行：
- 命中检测、伤害结算、Buff/Tag、掉落、死亡
- 技能时间轴（前摇开始/释放/弹道/命中时刻）

### 表现层（Presentation）
用视觉/音频/镜头/震动表达判定层发生的事：
- 指示器（预览范围、轨迹、危险区）
- 动画（施法动作、后坐力、受击/倒地）
- 特效（投射物、命中火花、Debuff 图标）
- UI（血条、资源、技能冷却、击杀/掉落提示）

**关键约束**：表现层必须能从“同一份 Skill 运行时参数”推导出可预览内容。\n+
## 7.2 主控角色（参考《Noita》与《魔法工艺》）
### 7.2.1 视角与输入（参考 Noita）
- **俯视角 2D**（像素风或简化几何体，本阶段可 2D）
- **移动**：WASD（支持八方向，参考 Noita 的流畅走位）
- **瞄准**：鼠标指向（实时跟随，参考 Noita 的鼠标瞄准）
- **施法触发**：
  - **左键**：主法术（CastConfirm），按住可连续施法（参考 Noita 的按住连发）
  - **右键**：副法术（可选，第二套 Assembly）
  - **Space**：翻滚/闪避（可选，参考 Noita 的翻滚机制，带短暂无敌帧）

### 7.2.2 角色状态机（参考 Noita）
状态机只为“手感”服务，判定仍由技能时间轴驱动：
- **Idle / Move**：基础状态，可随时移动
- **CastWindup（前摇）**：施法准备，参考 Noita 的施法前摇（可移动但降速）
- **CastRelease（释放帧）**：法术释放瞬间
- **CastRecovery（后摇）**：施法后摇，限制再次施法（参考 Noita 的充能时间）
- **Roll（翻滚）**：短暂无敌/减伤，参考 Noita 的翻滚机制
- **Hitstun（受击硬直）**：受击后短暂硬直（可选）
- **Death**：死亡状态

切换规则建议（参考 Noita）：
- **前摇中可移动但降速**（参考 Noita，允许走位施法）
- **后摇中可移动但不可再次施法**（参考 Noita 的充能机制）
- **翻滚中短暂无敌**（参考 Noita，约 0.2~0.3s）
### 7.2.3 资源与反馈（参考 Noita/魔法工艺）
最小资源：
- **HP**：生命值（参考 Noita，显示在 UI）
- **Mana**：法力值（参考 Noita 的充能系统，施法消耗，自动回复）
- **Ammo**：弹药（可选，某些模板使用）

反馈要求（参考 Noita）：
- **施法失败原因提示**：资源不足/冷却中/无目标（UI 提示）
- **命中反馈**：屏幕轻微震动/命中音效/伤害数字跳字（参考 Noita 的伤害数字）
- **资源不足提示**：Mana 不足时施法失败，UI 闪烁提示
## 7.3 施法体验：时间轴 + 指示器
### 7.3.1 技能时间轴（参考 Noita/魔法工艺）
每次施法从 CastConfirm 开始，最小拆分（参考 Noita 的施法流程）：
- **Windup 前摇**：显示指示器，允许玩家微调方向（参考 Noita，可移动但降速）
- **Release 释放**：生成投射物/范围体（判定开始，参考 Noita 的投射物生成）
- **Travel 飞行**：投射物速度决定命中时刻（参考 Noita 的弹道系统）
- **Resolve 结算**：命中/爆炸/上状态（参考 Noita 的命中判定）
- **Recovery 后摇**：限制再次施法（参考 Noita 的充能时间，可移动但不可再次施法）

这些时间参数必须来源于：
- Template/Option 的预置档位（玩家只能切换档位，不可细调，类似 Noita 的法术参数）

### 7.3.2 指示器类型（按模板）
对每个 Target/Action 形态提供对应指示器：
- **Line（直线）**：一条窄矩形或光束，显示最大射程\n+- **Cone（扇形）**：扇形区域，显示角度与距离\n+- **Circle（圆形）**：圆形地面贴花，显示半径\n+- **Dash（突进）**：地面路径 + 终点标记\n+- **Danger（怪物攻击预警）**：红色区域 + 边缘闪烁（见 7.4）

指示器显示时机：
- Windup 开始出现，Release 时刻消失或转为“落点确认”\n+- 若施法被取消（未来可加），指示器立即消失\n+
### 7.3.3 投射物与命中手感（参考 Noita）
投射物的“好手感”主要来自三个参数组合（参考 Noita 的投射物系统）：
- **速度**：太慢会“飘”，太快会“无反馈”（参考 Noita 的投射物速度档位）
- **宽度/判定半径**：决定容错（参考 Noita 的投射物大小）
- **命中反馈**：命中闪光/击中音效/击退感/伤害数字（参考 Noita 的命中反馈）

建议档位（参考 Noita）：
- **Fast**：speed=18u/s，容错小，适合近距离/高伤害
- **Mid**：speed=12u/s，容错中，平衡选择
- **Slow**：speed=8u/s，容错大但需更强命中反馈，适合 AOE/控制
### 7.3.4 关键“命中指引”规则
为了让玩家理解“为什么没打中”，需要：
- 施法时始终显示 **射程/范围**\n+- 命中失败时（空放/无目标），在准星附近提示“未命中/超出距离”\n+- 对 DoT 区域，显示持续边界与剩余时间（简化可只显示边界衰减）\n+
## 7.4 怪物具象化（简单但可读）
### 7.4.1 视觉规范（最小）
用形状 + 颜色保证可读性（即使是简笔/几何体也要像“怪”）：
- **MeleeGrunt**：小体型红色（近战压迫感）\n+- **RangedShooter**：细长或带“枪口”形状（远程）\n+- **EliteBrute**：大体型、深色/金属感，带明显护甲边缘（高防）\n+
统一规则：
- 头部朝向/枪口朝向与攻击方向一致\n+- HP 条固定在头顶，精英有更粗的血条\n+
### 7.4.2 攻击预警（Telegraph）
怪物攻击也要有“前摇 + 指示器”，否则玩家无法用走位体现手感：
- 近战：抬手 0.3s，玩家周围短扇形红区\n+- 远程：举枪 0.4s，直线红色细条 + 子弹飞行\n+- 精英：重击 0.6s，大圆形红区（或直线冲击波）\n+
预警与判定对齐：
- Telegraph 的持续时间 = 判定 Windup\n+- Release 时刻生成命中判定（近战/子弹）\n+
### 7.4.3 受击/死亡反馈
最低配置：
- 受击闪白 80ms\n+- 被击杀：缩放/碎裂/淡出 + 掉落弹出\n+- 精英死亡：额外音效与掉落更显眼\n+
## 7.5 与 ECA/模板体系的对齐点
### 表现参数从哪里来
建议把表现相关参数与判定参数一起作为 Option 的预置字段（但标记为 presentation）：
- `windupMs`、`recoveryMs`\n+- `projectileSpeed`、`indicatorShape`、`indicatorSize`\n+- `sfxId`、`vfxId`、`cameraShake`\n+
玩家依然只能选档位，不能自由输入。

### 事件点（给表现层挂钩）
执行器在关键时刻抛“表现事件”（不影响判定）：
- `OnCastWindupStart`\n+- `OnCastRelease`\n+- `OnProjectileSpawn`\n+- `OnHit`（命中确认）\n+- `OnKill`\n+
表现层消费这些事件来播放动画/特效/音效。

