# 关联性约束系统设计

## 1. 设计目标

在保持动态ECA生成系统的多样性的同时，通过关联性约束确保技能效果之间有合理的组合关系，避免过于自由导致技能无效或体验差。

## 2. 系统架构

### 2.1 关联性约束类型

#### 耦合关系（Coupling）
- **定义**：强依赖关系，缺少依赖效果会导致技能有效性大幅下降
- **示例**：
  - 反击需要续航（heal/shield/lifesteal）
  - 处决需要控制（slow/root/stun）
  - 区域持续伤害需要控制（slow/root/pull）
  - 自身负面效果需要高收益补偿（高伤害/暴击）

#### 协同关系（Synergy）
- **定义**：效果组合有叠加收益，但可以独立存在
- **示例**：
  - 穿透+分裂：穿透后分裂，范围伤害提升
  - 减速+定身：双重控制
  - 流血+处决：流血降低血量，处决更容易触发

### 2.2 约束应用时机

1. **模板生成阶段**：在生成动作槽位时，检查是否需要添加依赖效果
2. **选项选择阶段**：在选择具体选项时，根据已选择的选项调整后续选项的权重或直接替换

## 3. 实现方式

### 3.1 耦合关系检查

在选项选择阶段（`generateRandomWeapon`函数中）：
1. 遍历所有已选择的选项
2. 检查每个选项的效果ID是否有耦合关系
3. 如果缺少依赖效果，根据权重概率调整后续选项以满足依赖

### 3.2 权重调整

- 如果当前选项需要依赖效果，提高依赖效果选项的权重
- 如果依赖效果已经在后续槽位中，优先选择依赖效果选项

### 3.3 选项替换

- 如果当前选项需要依赖效果，且后续槽位中有匹配的依赖效果选项，替换当前选项
- 确保技能的有效性和体验质量

## 4. 优势

1. **保持多样性**：不限制选项池，仍然从所有ACTION_RULES中选择
2. **提升有效性**：通过关联性约束确保技能效果之间有合理的组合
3. **灵活调整**：可以根据权重控制约束的严格程度
4. **向后兼容**：不影响现有的动态生成逻辑

## 5. 配置位置

- **耦合关系定义**：`engine/coupling.js` - `COUPLING_RELATIONS`
- **协同关系定义**：`engine/synergy.js` - `SYNERGY_COMBOS`
- **应用逻辑**：`engine/randomWeapon.js` - `generateRandomWeapon`函数中的选项选择阶段
