# 主效果与副效果系统设计

## 1. 设计理念

参考流放之路2的BD设计，采用**主效果（Core）+ 副效果（Support）**架构：

- **主效果**：提供核心技能功能，满足差异化随机体验
- **副效果**：对主效果产生正向加成，可能带来负面效果（trade-off）

## 2. 系统架构

### 2.1 主效果（Core Skills）

主效果定义了技能的基础类型和能力，包括：

- **投射类**：基础投射、多弹投射、连发投射、爆炸投射
- **光束类**：短光束、长光束
- **近战类**：单体近战、扇形近战
- **区域类**：区域持续伤害
- **特殊类**：召唤

每个主效果包含：
- `id`: 唯一标识
- `label`: 显示名称
- `category`: 类别（用于兼容性检查）
- `baseAction`: 基础动作配置（伤害公式、预算、表现参数等）
- `baseBudget`: 基础预算
- `weight`: 选择权重

### 2.2 副效果（Support Modifiers）

副效果对主效果进行修饰和增强，包括：

#### 伤害加成类
- **更多伤害**：50%更多伤害
- **增加伤害**：30%更多伤害
- **残暴伤害**：100%更多伤害（负面：30%减速）

#### 投射物修饰类
- **追踪**：添加追踪效果（速度降低30%）
- **穿透**：穿透3个目标
- **分裂**：命中后分裂成3发（主投射物伤害降低20%）
- **连锁**：连锁3个目标（主投射物伤害降低15%）
- **爆炸**：命中后爆炸（主投射物伤害降低30%）

#### 控制效果类
- **减速**：30%减速，持续2秒
- **眩晕**：眩晕0.8秒
- **易伤**：15%易伤，持续3秒

#### 范围扩展类
- **范围扩大**：范围扩大50%
- **巨大范围**：范围扩大100%（伤害降低20%，负面：20%减速）

#### 速度/手感类
- **快速施法**：前摇和后摇减少30%
- **快速投射**：投射物速度提升50%
- **慢速强击**：速度降低40%，伤害提升80%，前摇增加50%

#### 特殊机制类
- **蓄力**：支持蓄力机制，蓄满伤害翻倍
- **多重施法**：施法2次（负面：25%减速）

#### 增益类
- **生命偷取**：20%伤害转化为生命
- **命中护盾**：每次命中获得30护盾

#### 高风险高回报类
- **狂暴**：150%更多伤害，50%更快攻击速度（负面：20%易伤，15%减速）
- **过载**：200%更多伤害，范围扩大80%（负面：定身1秒，30%易伤）

### 2.3 兼容性规则

副效果与主效果的兼容性：

- **投射物修饰类**：只能用于投射类主效果
- **区域修饰类**：可用于区域和投射类主效果
- **投射物速度类**：只能用于投射类主效果
- **其他类别**：通常通用

## 3. 生成流程

### 3.1 主效果选择

1. 根据权重从`CORE_SKILLS`中随机选择一个主效果
2. 记录主效果的`id`和`category`

### 3.2 副效果选择

1. 根据复杂度确定最大副效果数量（0-3个）
2. 从兼容的副效果中加权随机选择
3. 避免重复选择

### 3.3 效果应用

1. **应用副效果到主效果**：
   - 伤害倍数：修改伤害公式
   - 投射物修饰：添加修饰符（追踪、穿透、分裂等）
   - 速度倍数：修改投射物速度
   - 前摇/后摇倍数：修改施法时间
   - 范围倍数：修改范围参数
   - 特殊机制：添加蓄力、多重施法等

2. **收集负面效果**：
   - 从副效果的`negativeEffects`中收集所有负面效果
   - 创建`SelfDebuff`动作槽位

3. **生成技能结构**：
   - 主效果动作槽位（已应用副效果）
   - 负面效果动作槽位（SelfDebuff）
   - 副效果添加的Debuff动作槽位（如果有）

## 4. 负面效果系统

### 4.1 负面效果类型

- **selfSlow**：自身减速
- **selfVuln**：自身易伤
- **selfRoot**：自身定身

### 4.2 负面效果应用

负面效果通过`SelfDebuff`动作类型应用到施法者自身：

```javascript
case "SelfDebuff":
  // 应用到施法者自身
  if (selfDebuff.kind === "selfSlow") {
    caster.buffs.slow = { power: ..., until: ... };
  } else if (selfDebuff.kind === "selfVuln") {
    caster.buffs.vulnerable = { power: ..., until: ... };
  } else if (selfDebuff.kind === "selfRoot") {
    caster.rootedUntil = ...;
  }
```

## 5. 技能描述生成

技能描述优先使用主效果+副效果架构：

```
[事件条件] + [主效果名称]（[副效果1、副效果2]）【负面：[负面效果1、负面效果2】】
```

示例：
- "基础投射（追踪、穿透）"
- "多弹投射（更多伤害、爆炸）【负面：自身减速】"
- "连发投射（残暴伤害、快速投射）【负面：自身减速、自身易伤】"

## 6. 优势

1. **清晰的技能结构**：主效果提供核心功能，副效果提供修饰
2. **更好的平衡性**：通过负面效果平衡强力副效果
3. **更高的多样性**：主效果×副效果组合产生大量变化
4. **更好的可读性**：技能描述更清晰易懂
5. **参考成熟设计**：借鉴流放之路2的BD设计理念

## 7. 配置位置

- **主效果定义**：`configs/skillArchetypes.js` - `CORE_SKILLS`
- **副效果定义**：`configs/skillArchetypes.js` - `SUPPORT_MODIFIERS`
- **生成逻辑**：`engine/randomWeapon.js` - `generateDynamicTemplate`
- **效果应用**：`configs/skillArchetypes.js` - `applySupportModifier`
- **负面效果处理**：`engine/ops.js` - `SelfDebuff` case
- **描述生成**：`engine/skillDescription.js` - `generateGenericDescription`
