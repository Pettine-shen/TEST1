# 效果耦合关系系统设计

## 设计理念

与**协同收益系统（Synergy）**不同，**耦合关系系统（Coupling）**关注的是效果之间的**强依赖关系**。某些效果如果单独存在，其有效性会大幅下降，需要配合其他效果才能发挥最大价值。

### 与Synergy的区别

- **Synergy（协同收益）**：效果组合有"叠加收益"（bonus），但可以独立存在
- **Coupling（耦合关系）**：效果组合有"强依赖关系"，缺少依赖效果会导致技能有效性大幅下降

## 耦合关系定义

### 格式

```javascript
{
  effect: "主效果ID",
  requires: ["依赖效果ID数组"],
  priority: 优先级(1-10, 10最高),
  description: "描述",
  weight: 权重(0-1, 1表示100%概率同时生成)
}
```

### 主要耦合关系分类

#### 1. 反击类效果需要续航支持

- **反击（counter）** → 需要：恢复、护盾、生命偷取
  - 原因：反击会频繁触发，需要恢复或护盾保证生存
  - 优先级：10（最高）
  - 权重：0.8

- **反弹伤害（reflect）** → 需要：恢复、护盾
  - 原因：反弹伤害时自身也会受到伤害，需要恢复或护盾
  - 优先级：9
  - 权重：0.7

#### 2. 高伤害技能需要控制支持

- **处决伤害（execute）** → 需要：减速、定身、眩晕
  - 原因：处决需要敌人血量低，控制效果帮助降低敌人血量并防止逃跑
  - 优先级：9
  - 权重：0.75

- **蓄力技能（charge）** → 需要：定身、眩晕、减速
  - 原因：蓄力时间长，需要控制敌人防止其逃跑或打断
  - 优先级：8
  - 权重：0.7

- **慢速投射物（proj_slow）** → 需要：减速、定身、眩晕
  - 原因：慢速投射物容易被躲避，控制效果提高命中率
  - 优先级：8
  - 权重：0.65

#### 3. 持续伤害需要控制支持

- **区域持续伤害（areaDoT）** → 需要：减速、定身、拉回
  - 原因：敌人需要停留在区域内，控制效果防止其离开
  - 优先级：9
  - 权重：0.8

- **流血伤害（bleed）** → 需要：减速、定身
  - 原因：流血是持续伤害，控制效果防止敌人逃跑
  - 优先级：7
  - 权重：0.6

- **悬停投射物（hover）** → 需要：减速、定身
  - 原因：悬停投射物需要敌人停留在范围内，控制效果提高命中率
  - 优先级：7
  - 权重：0.6

#### 4. 突进类技能需要防护支持

- **突进（dash）** → 需要：护盾、无敌、恢复
  - 原因：突进会接近敌人，需要防护避免被集火
  - 优先级：8
  - 权重：0.7

- **闪现（blink）** → 需要：护盾、隐身
  - 原因：闪现后可能处于危险位置，需要防护或隐身
  - 优先级：7
  - 权重：0.65

- **跳跃（jump）** → 需要：护盾、无敌
  - 原因：跳跃过程中可能受到攻击，需要防护
  - 优先级：6
  - 权重：0.6

#### 5. 易伤效果需要高伤害配合

- **易伤debuff（vulnerable）** → 需要：高伤害、暴击、处决、连锁、弹跳
  - 原因：易伤debuff需要配合高伤害技能才能发挥最大效果
  - 优先级：9
  - 权重：0.8

#### 6. 标记效果需要处决或奖励配合

- **标记（mark）** → 需要：处决、标记奖励
  - 原因：标记通常配合处决伤害或击杀奖励使用
  - 优先级：8
  - 权重：0.75

#### 7. 充能效果需要高伤害配合

- **充能（stack）** → 需要：高伤害、暴击、处决
  - 原因：充能后应该释放高伤害技能才能发挥最大价值
  - 优先级：7
  - 权重：0.7

#### 8. 控制效果组合（先控后打）

- **拉回（pull）** → 需要：眩晕、定身、伤害
  - 原因：拉回敌人后需要控制或伤害，否则敌人会立即反击
  - 优先级：8
  - 权重：0.75

- **击退（knockback）** → 需要：减速、定身
  - 原因：击退后减速或定身，防止敌人快速返回
  - 优先级：6
  - 权重：0.6

#### 9. 范围技能需要目标选择配合

- **区域持续伤害（areaDoT）** → 需要：范围内所有、扇形
  - 原因：区域伤害配合范围目标选择效果更好
  - 优先级：6
  - 权重：0.5

#### 10. 连锁/弹跳需要多目标配合

- **连锁伤害（chain）** → 需要：范围内所有、扇形
  - 原因：连锁伤害需要多个敌人才能发挥最大效果
  - 优先级：7
  - 权重：0.7

- **弹跳伤害（bounce）** → 需要：范围内所有、扇形
  - 原因：弹跳伤害需要多个敌人才能发挥最大效果
  - 优先级：7
  - 权重：0.7

#### 11. 自身负面效果需要收益补偿

- **自身易伤（selfVuln）** → 需要：高伤害、暴击、攻击加成
  - 原因：自身易伤是负面效果，需要高伤害或攻击加成补偿
  - 优先级：9
  - 权重：0.85

- **自身减速（selfSlow）** → 需要：高伤害、暴击
  - 原因：自身减速是负面效果，需要高伤害补偿
  - 优先级：8
  - 权重：0.8

- **自身定身（selfRoot）** → 需要：高伤害、暴击、处决
  - 原因：自身定身是严重负面效果，需要极高伤害补偿
  - 优先级：9
  - 权重：0.9

#### 12. 召唤需要保护或控制配合

- **召唤（summon）** → 需要：护盾、减速、定身
  - 原因：召唤物需要时间发挥作用，控制或防护帮助创造环境
  - 优先级：6
  - 权重：0.5

#### 13. 光束需要控制配合

- **光束（beam）** → 需要：减速、定身、眩晕
  - 原因：光束是持续伤害，控制效果防止敌人离开光束范围
  - 优先级：7
  - 权重：0.65

#### 14. 追踪投射物需要穿透或分裂配合

- **追踪（homing）** → 需要：穿透、分裂、弹跳
  - 原因：追踪投射物配合穿透或分裂可以命中更多敌人
  - 优先级：6
  - 权重：0.5

## 实现机制

### 1. 效果ID提取

`extractEffectIdsForCoupling(option)` 函数从选项对象中提取效果ID，用于耦合检查。

### 2. 耦合关系检查

`checkCouplingRequirement(effectIds, newEffectId)` 检查新添加的效果是否需要依赖效果。

### 3. 推荐依赖效果

`getRecommendedCouplingEffects(effectIds, newEffectId)` 返回推荐补充的依赖效果列表。

### 4. 随机生成中的应用

在 `randomWeapon.js` 中：

1. **第一遍**：正常选择所有选项
2. **第二遍**：检查耦合关系，如果发现某个效果需要依赖效果但未满足：
   - 根据权重（weight）决定是否调整
   - 在后续的Action槽位中寻找匹配的依赖效果
   - 如果找到，替换选项以满足耦合关系

## 效果

通过耦合关系系统：

1. **提升技能有效性**：确保关键效果有必要的支持效果
2. **减少无效组合**：避免生成"反击但没有恢复"、"处决但没有控制"等无效组合
3. **保持多样性**：通过权重控制，不是100%强制，仍然保持一定的随机性
4. **优先级机制**：高优先级的效果（如反击+恢复）更容易被应用

## 未来扩展

1. **反向耦合**：某些效果不应该同时出现（如"自身易伤"和"护盾"可能冲突）
2. **三元素耦合**：某些效果需要两个依赖效果（如"处决+控制+易伤"）
3. **模板特定耦合**：某些模板可能有特定的耦合规则
4. **动态权重调整**：根据游戏平衡数据动态调整权重
