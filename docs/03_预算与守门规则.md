# 03 预算与守门规则

## 目的
即使玩家只能“重排顺序”，也可能出现：
- 高频触发导致性能压力（尤其 OnDamaged/OnHit）
- 组合导致强度过高（先控后爆、延迟叠加、AOE 过大）

因此需要两类管控：
- **预算（Budget）**：在配置层约束技能“能力上限”
- **守门（Guards）**：在运行时约束“触发频率与资源消耗/性能上限”

## 预算（Budget）
### 预算维度（建议最小集合）
- `damage`：伤害能力预算（期望伤害/爆发）
- `cc`：控制预算（硬控秒数、减速强度*持续）
- `mobility`：机动预算（位移距离/频率）
- `proc`：触发风险预算（OnHit/OnDamaged/OnTick 类）
- `perf`：性能预算（空间查询/生成物/DoT tick 等）

### 标价原则
每个 SlotOption（档位）带一个 `budgetDelta`：
- 伤害档位越高，`damage` 越高
- AOE 范围越大，`perf` 越高
- 硬控越长，`cc` 越高
- 触发概率越高，`proc` 越高

模板提供 `budgetCap`，编译 Assembly 时要求：
\n- `sum(option.budgetDelta) <= template.budgetCap`

### 为什么“重排顺序”仍需预算
顺序变化会改变收益的“实现方式”（命中率、覆盖率、触发窗口），如果不设预算与守门，可能出现“通过顺序把同一套能力变成更稳定/更高收益”的极端情况，导致模板内某些顺序成为唯一最优。

预算的目标不是完全消除最优解，而是保证：
- 最优解的优势可接受（不是碾压）
- 任何合法顺序都不会突破强度/性能红线

## 守门（Guards）
守门是模板级硬约束（玩家不可移除），常见规则：

### 1) 高频事件必限频
- `OnDamaged` / `OnHit` / `OnTick` 触发模板必须满足：
  - `ICD >= X ms` 或 `CapPerSecond <= N`
  - 建议本阶段：`ICD=800ms`，`CapPerSecond=2`（已用于反击模板）

### 2) 生成物/查询上限（PerfGuard）
- 单次释放最大目标数：`Target.max`
- 单次释放最大 AOE 查询次数：通过 Target/DoT 预算限制
- 单次释放最大生成物数量：`MaxSpawns`
- 单位时间最大动作数：`MaxActionsPerSecond`

（本阶段简化模拟尚未引入生成物数量，但设计上必须保留该 guard 概念）

### 3) 禁止递归触发（AntiLoop）
本阶段不开放 `TriggerEvent` 或循环结构；后续若开放，必须同时具备：
- 最大递归深度
- 每帧最大事件数
- 每技能每秒最大触发数

## PVE 专用规则
PVE 中允许存在“经济动作”（掉落加成、材料掉落表），但必须满足：
- 掉落由服务器/模拟器的经济表控制，不由玩家参数直接决定
- 掉落动作只读取“是否满足条件”（例如带印记击杀），不读取可被玩家操控的随机源

## 校验时机
- **保存/锻造阶段（静态校验）**：预算、禁用项、守门存在性、slot/order 合法性
- **战斗阶段（动态守门）**：ICD/Cap、动作数上限、调度队列上限

