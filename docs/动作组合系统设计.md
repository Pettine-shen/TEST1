# 动作组合系统设计

## 概述

动作组合系统将原本固定的动作规则（ACTION_RULES）拆分成**基础动作类型**和**修饰符**，通过自由组合实现更高的多样性。

## 设计理念

### 问题
- **固定穷举限制多样性**：原有的 ACTION_RULES 是预定义的完整动作，只能从固定选项中选择
- **组合数量有限**：即使有100个预定义动作，组合数量仍然受限于这100个选项
- **难以扩展**：添加新效果需要创建完整的动作规则，无法复用已有组件

### 解决方案
- **原子化拆分**：将动作拆分成基础类型（Base Action Types）和修饰符（Modifiers）
- **自由组合**：通过组合规则（Composition Rules）定义哪些修饰符可以组合
- **动态生成**：每次生成时动态组合，理论上可以产生数千种不同的动作

## 系统架构

### 1. 基础动作类型（Base Action Types）

定义动作的核心行为，包括：
- **投射物类**：`SpawnProjectile`
- **直接伤害类**：`Damage`
- **光束类**：`Beam`
- **区域持续伤害类**：`SpawnAreaDoT`
- **控制类**：`Debuff`
- **增益类**：`Heal`, `Buff`
- **移动类**：`Dash`, `Blink`
- **特殊机制类**：`Charge`, `Summon`, `Mark`

每个基础类型包含：
- `id`: 唯一标识
- `label`: 显示名称
- `kind`: 动作类型（用于运行时识别）
- `baseBudget`: 基础预算消耗
- `baseFormula`: 基础伤害公式（如果有）
- `basePresentation`: 基础表现参数
- `compatibleModifiers`: 可兼容的修饰符类型列表

### 2. 修饰符（Modifiers）

修饰符分为多个类别：

#### 投射物修饰符（Projectile Modifiers）
- `homing`: 追踪
- `ricochet`: 弹跳
- `spiral`: 螺旋
- `orbit`: 环绕
- `return`: 回旋
- `hover`: 悬停
- `pierce`: 穿透
- `explosive`: 爆炸

#### 伤害修饰符（Damage Modifiers）
- `crit`: 暴击
- `execute`: 处决
- `percent`: 百分比伤害
- `trueDamage`: 真实伤害
- `bleed`: 流血
- `chain`: 连锁
- `bounce`: 弹射
- `split`: 分裂

#### 数量修饰符（Quantity Modifiers）
- `scatter3`: 3弹散射
- `scatter5`: 5弹散射
- `burst3`: 3连发
- `burst5`: 5连发

#### 范围修饰符（Area Modifiers）
- `cone`: 扇形
- `line`: 直线
- `circle`: 圆形

#### 控制修饰符（Debuff Modifiers）
- `slow`: 减速
- `root`: 定身
- `stun`: 眩晕
- `silence`: 沉默
- `disarm`: 缴械
- `fear`: 恐惧
- `charm`: 魅惑
- `vulnerable`: 易伤
- `knockback`: 击退
- `pull`: 拉回

#### 增益修饰符（Buff Modifiers）
- `atkBoost`: 攻击提升
- `speedBoost`: 速度提升
- `defBoost`: 防御提升
- `shield`: 护盾
- `stealth`: 隐身
- `haste`: 急速

每个修饰符包含：
- `id`: 唯一标识
- `label`: 显示名称
- `weight`: 选择权重
- `budget`: 预算消耗
- `data`: 修饰符数据（会被合并到动作中）
- `presentation`: 表现参数调整（可选）
- `formulaMultiplier`: 公式倍数（用于调整伤害）

### 3. 组合规则（Composition Rules）

定义每个基础类型可以组合的修饰符：

```javascript
SpawnProjectile: {
  maxModifiers: 2, // 最多2个修饰符
  allowedCombinations: [
    ["projectileModifier", "damageModifier"],
    ["projectileModifier", "quantityModifier"],
    // ...
  ],
  exclusivePairs: [
    ["orbit", "return"], // 环绕和回旋互斥
    ["scatter3", "scatter5"], // 不同散射数量互斥
  ],
}
```

## 组合流程

### 1. 选择基础类型
根据技能性格和策略维度，使用权重选择基础动作类型。

### 2. 选择修饰符
- 根据组合规则确定可选的修饰符类型
- 随机选择修饰符数量（1-2个，受 `maxModifiers` 限制）
- 检查互斥规则，避免冲突组合
- 使用权重随机选择修饰符

### 3. 组合生成
- 调用 `composeAction(baseType, modifiers, rng)` 函数
- 合并预算、数据、表现参数
- 应用公式倍数调整伤害
- 生成唯一ID和标签

### 4. 生成选项
每个动作槽位生成3-5个不同的组合选项，供玩家选择。

## 多样性提升

### 理论组合数量

假设：
- 10个基础动作类型
- 每个基础类型平均可组合3类修饰符
- 每类修饰符平均5个选项
- 每个动作最多2个修饰符

**单个修饰符组合数**：
- 投射物：8个修饰符 × 10个基础类型 = 80种
- 伤害：8个修饰符 × 10个基础类型 = 80种
- 数量：4个修饰符 × 10个基础类型 = 40种
- 总计：200种单修饰符组合

**两个修饰符组合数**：
- 投射物+伤害：8 × 8 × 10 = 640种
- 投射物+数量：8 × 4 × 10 = 320种
- 伤害+数量：8 × 4 × 10 = 320种
- 总计：1280种双修饰符组合

**总组合数**：200 + 1280 = **1480种**（远超原有的100多个固定动作）

### 实际多样性

- **动态生成**：每次生成时随机组合，避免固定模式
- **权重调整**：根据性格和策略维度调整选择权重，确保差异化
- **互斥规则**：避免不合理的组合
- **去重机制**：同一槽位内避免重复组合

## 兼容性

### 向后兼容
- 保留原有的 `ACTION_RULES` 作为后备
- `hasDamageTag` 函数仍然可以识别组合后的动作
- 运行时执行逻辑（`engine/ops.js`）无需修改

### 扩展性
- 添加新修饰符：只需在对应修饰符池中添加
- 添加新基础类型：定义基础类型和组合规则即可
- 调整组合规则：修改 `COMPOSITION_RULES` 即可

## 使用示例

### 生成一个"追踪+暴击"的投射物

```javascript
const baseType = BASE_ACTION_TYPES.SpawnProjectile;
const modifiers = [
  PROJECTILE_MODIFIERS.homing,
  DAMAGE_MODIFIERS.crit
];
const action = composeAction(baseType, modifiers, rng);

// 结果：
// {
//   id: "SpawnProjectile_homing_crit_abc123",
//   kind: "SpawnProjectile",
//   label: "投射物(追踪+暴击)",
//   formula: { scale: 0.54, flat: 18 }, // 0.6 * 0.9 * 1.0
//   homing: { turnRate: 0.15, loseTargetRange: 10 },
//   critChance: 0.25,
//   critMultiplier: 2.0,
//   budget: { damage: 20, perf: 13, proc: 15 },
//   presentation: { windupMs: 150, projectileSpeed: 8 }
// }
```

### 生成一个"3弹散射+爆炸"的投射物

```javascript
const baseType = BASE_ACTION_TYPES.SpawnProjectile;
const modifiers = [
  QUANTITY_MODIFIERS.scatter3,
  PROJECTILE_MODIFIERS.explosive
];
const action = composeAction(baseType, modifiers, rng);

// 结果：
// {
//   id: "SpawnProjectile_scatter3_explosive_xyz789",
//   kind: "SpawnMultipleProjectiles", // 数量修饰符改变了类型
//   label: "投射物(3弹散射+爆炸)",
//   count: 3,
//   spreadAngle: 45,
//   spreadType: "fan",
//   explosionFormula: { scale: 1.5, flat: 55 },
//   explosionRadius: 2.5,
//   formula: { scale: 0.455, flat: 14 }, // 0.6 * 0.65 * 0.7
//   budget: { damage: 20, perf: 30 }
// }
```

## 未来优化方向

1. **智能组合**：根据技能性格自动推荐合适的修饰符组合
2. **组合效果**：某些修饰符组合产生特殊效果（如"追踪+分裂"产生追踪分裂弹）
3. **动态权重**：根据已选择的修饰符动态调整后续修饰符的权重
4. **组合验证**：运行时验证组合的有效性，避免无效组合

## 文档状态

✅ **当前实现** - 已集成到随机武器生成系统中
