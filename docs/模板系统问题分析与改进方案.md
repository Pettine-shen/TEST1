# 模板系统问题分析与改进方案（历史文档）

> **状态**：历史文档  
> **说明**：本文档说明了为什么废弃固定模板系统，改为动态ECA生成系统。当前实现已采用动态生成系统，本文档保留作为历史参考。

## 问题分析

### 当前模板系统的限制

1. **模板数量限制多样性**
   - 只有5套模板，选择范围极其有限
   - 即使每个模板有大量选项，模板结构本身限制了变化

2. **固定槽位结构**
   - 每个模板的槽位数量和类型是固定的
   - 无法动态组合不同的ECA元素
   - 例如：无法将"远程投射物模板"的投射物选项与"近战爆发模板"的位移选项组合

3. **事件类型绑定**
   - 每个模板绑定一个事件类型（CastConfirm、OnDamaged等）
   - 无法创建混合事件类型的技能

4. **组合数瓶颈**
   - 即使扩展选项，模板结构本身限制了最大组合数
   - 低多样性模板（如tpl_mark_exec_v1）即使扩展后也只有162种组合

---

## 模板存在的必要性分析

### 模板的原始目的

1. **安全性控制**
   - 限制玩家自定义范围，避免安全风险
   - 通过预算系统控制技能强度

2. **平衡性保证**
   - 通过`budgetCap`限制技能强度上限
   - 通过`guards`（ICD、限频）控制触发频率

3. **结构合理性**
   - 确保技能有合理的ECA结构
   - 避免生成无效或混乱的技能组合

4. **事件类型约束**
   - 确保技能有明确的触发条件
   - 例如：反击技能必须绑定`OnDamaged`事件

### 模板是否真的必要？

**结论**：模板的**核心约束**（预算、Guards、事件类型）是必要的，但**固定槽位结构**不是必需的。

---

## 改进方案：基于ECA规则的动态生成

### 核心思想

**不再使用固定模板结构，而是基于ECA规则动态生成技能结构。**

### 方案设计

#### 1. ECA规则池（替代模板）

```javascript
// 定义ECA规则池，而不是固定模板
const ECA_RULES = {
  // 事件规则
  events: [
    { id: "CastConfirm", guards: {}, budgetCap: { damage: 140, cc: 60, mobility: 0, proc: 40, perf: 50 } },
    { id: "OnDamaged", guards: { icdMs: 800, capPerSecond: 2 }, budgetCap: { damage: 100, cc: 80, mobility: 0, proc: 40, perf: 30 } },
  ],
  
  // 条件规则池
  conditions: [
    { id: "mana30", kind: "HasResource", resource: "mana", amount: 30, budget: {} },
    { id: "range12", kind: "InRange", max: 12, budget: {} },
    // ... 更多条件选项
  ],
  
  // 目标规则池
  targets: [
    { id: "single", kind: "singleNearest", budget: {}, presentation: {...} },
    { id: "cone", kind: "cone", range: 10, max: 3, budget: { perf: 4 }, presentation: {...} },
    // ... 更多目标选项
  ],
  
  // 动作规则池
  actions: [
    { id: "proj_fast", kind: "SpawnProjectile", formula: {...}, budget: { damage: 18, perf: 6 }, presentation: {...} },
    { id: "dash5", kind: "Dash", distance: 5, budget: { mobility: 20 }, presentation: {...} },
    // ... 更多动作选项
  ],
  
  // 时间线规则池
  timelines: [
    { id: "no_delay", delayMs: 0, budget: {} },
    { id: "delay250", delayMs: 250, budget: { damage: 5 } },
    // ... 更多时间线选项
  ],
};
```

#### 2. 动态结构生成规则

**规则定义**：
```javascript
const STRUCTURE_RULES = {
  // 最小结构要求
  minSlots: 4,
  maxSlots: 8,
  
  // 必须包含的元素
  required: {
    event: 1,        // 必须有1个事件
    action: [1, 4],  // 必须有1-4个动作
  },
  
  // 可选元素
  optional: {
    condition: [0, 3],  // 0-3个条件
    target: [0, 2],     // 0-2个目标选择
    timeline: [0, 3],   // 0-3个时间线
  },
  
  // 约束规则
  constraints: [
    // 如果有投射物动作，建议有目标选择
    { if: { action: { kind: "SpawnProjectile" } }, then: { target: { min: 1 } } },
    // 如果有OnDamaged事件，必须有触发概率条件
    { if: { event: "OnDamaged" }, then: { condition: { kind: "ProcChance", min: 1 } } },
  ],
};
```

#### 3. 动态生成流程

```
1. 选择事件类型（根据事件规则）
   ↓
2. 确定槽位数量（minSlots到maxSlots之间随机）
   ↓
3. 生成必需元素（1个事件，1-4个动作）
   ↓
4. 生成可选元素（条件、目标、时间线）
   ↓
5. 应用约束规则（调整结构以满足约束）
   ↓
6. 随机重排顺序
   ↓
7. 为每个槽位选择选项（从对应的规则池中选择）
   ↓
8. 检查预算和Guards
   ↓
9. 编译Assembly
```

#### 4. 预算和Guards继承

**预算继承**：
- 从事件规则中继承`budgetCap`
- 所有选择的选项的预算总和不能超过`budgetCap`

**Guards继承**：
- 从事件规则中继承`guards`（如ICD、限频）
- 这些Guards是硬约束，不可移除

---

## 方案对比

### 当前模板系统

**优点**：
- 结构清晰，易于理解和配置
- 安全性高，完全可控
- 易于平衡调整

**缺点**：
- 多样性受限（只有5套模板）
- 无法跨模板组合
- 扩展困难（需要新增完整模板）

### 动态ECA规则系统

**优点**：
- **极高的多样性**：理论上可以生成数千万种不同的技能结构
- **灵活组合**：可以自由组合任何ECA元素
- **易于扩展**：只需在规则池中添加新选项，无需创建完整模板
- **保持安全性**：仍然通过预算和Guards控制

**缺点**：
- 实现复杂度较高
- 需要更完善的约束规则系统
- 可能需要更多的测试和平衡调整

---

## 实施建议

### 阶段1：混合方案（推荐）

**保留模板系统，但增加"动态模板生成"功能**：

1. **保留现有模板**：作为"预设模板"，保证稳定性和平衡性
2. **新增动态生成模式**：基于ECA规则动态生成技能结构
3. **玩家选择**：玩家可以选择使用预设模板或动态生成

**优势**：
- 保持向后兼容
- 逐步验证动态生成系统
- 给玩家更多选择

### 阶段2：完全动态化（长期目标）

**完全移除模板系统，改为纯ECA规则系统**：

1. **移除模板概念**：不再有固定模板结构
2. **纯规则驱动**：所有技能都基于ECA规则动态生成
3. **增强约束系统**：通过更完善的约束规则保证结构合理性

**优势**：
- 最大化多样性
- 系统更灵活
- 更容易扩展新机制

---

## 技术实现要点

### 1. 约束规则系统

需要实现一个约束规则引擎，能够：
- 检查结构是否满足约束
- 自动调整结构以满足约束
- 验证生成的技能是否合理

### 2. 预算聚合

需要确保动态生成的技能仍然满足预算限制：
- 从事件规则继承`budgetCap`
- 聚合所有选项的预算
- 如果超限，重新生成或调整选项

### 3. Guards继承

确保Guards正确继承：
- 从事件规则继承`guards`
- 这些Guards是硬约束，不可移除

### 4. 结构验证

需要验证生成的技能结构是否合理：
- 必须有事件和动作
- 条件、目标、时间线的数量在合理范围内
- 满足所有约束规则

---

## 结论

**模板系统确实大幅削弱了武器的多样性**，主要原因：

1. **模板数量限制**：只有5套模板，选择范围极其有限
2. **固定结构限制**：无法跨模板组合，无法动态调整结构
3. **组合数瓶颈**：即使扩展选项，模板结构本身限制了最大组合数

**改进方向**：

1. **短期**：继续扩展模板选项，增加模板数量（10-15套）
2. **中期**：引入混合方案，保留模板的同时增加动态生成模式
3. **长期**：完全移除模板系统，改为基于ECA规则的动态生成系统

**核心原则**：保持安全性（预算、Guards）和平衡性，但移除结构限制，最大化多样性。
