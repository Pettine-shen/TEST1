# 10 技能描述与随机武器系统

## 10.1 设计目标

基于 ECA 组装系统，为玩家提供：
1. **技能描述生成**：根据 Assembly 自动生成一句话技能描述，帮助玩家快速理解技能能力
2. **ECA 拼装可视化**：展示技能的模块类型和执行顺序，调整后实时更新描述
3. **随机武器系统**：每次体验获得不同的随机技能，增加探索乐趣

## 10.2 技能描述生成规则

### 10.2.1 描述生成原则

技能描述应**一句话概括核心能力**，参考《Noita》和《魔法工艺》的技能命名风格：

- **简洁明了**：一句话（15-30字）描述技能的主要效果
- **突出特色**：强调技能的核心差异点（例如"穿透"、"扇形"、"反击"）
- **顺序敏感**：描述应反映顺序重排带来的语义变化

### 10.2.2 描述生成算法

基于 Assembly 的 `order` 和 `slotOptions`，按以下规则生成：

1. **识别核心 Action**：找到第一个主要的 Action（SpawnProjectile/Damage/Dash/SpawnAreaDoT）
2. **识别 Target 类型**：找到 Target 模块，确定范围类型（Line/Cone/Circle）
3. **识别关键 Condition**：识别影响技能特性的 Condition（如距离限制、资源消耗）
4. **识别 Timeline 影响**：识别延迟/后摇对节奏的影响
5. **组合描述**：按"触发方式 + 目标类型 + 核心效果 + 特色"的格式组合

### 10.2.3 描述模板示例

**远程投射类**：
- `tpl_ranged_proj_v1` + `line` + `proj_fast` → "向最近敌人发射快速穿透弹"
- `tpl_ranged_proj_v1` + `coneW` + `proj_pierce` → "扇形范围发射穿透弹，可命中多个目标"
- `tpl_ranged_proj_v1` + `range18` + `dmg_high` → "远距离高伤害直线攻击"

**近战爆发类**：
- `tpl_melee_burst_v1` + `dash5` + `cone_hit` → "向前突进5米后释放扇形高伤害"
- `tpl_melee_burst_v1` + `knockback` + `dmg_high` → "近战爆发后击退敌人"

**反击类**：
- `tpl_counter_v1` + `proc35` + `pulse` → "受击时35%概率触发3米范围脉冲反击"
- `tpl_counter_v1` + `silence` + `dmg_mid` → "受击反击，沉默敌人并造成中等伤害"

**地面持续类**：
- `tpl_ground_dot_v1` + `r4` + `area6s` → "在4米半径圆形区域释放6秒持续伤害"
- `tpl_ground_dot_v1` + `slow15` + `area4s` → "地面持续伤害，同时减速区域内敌人"

**标记收割类**：
- `tpl_mark_exec_v1` + `mark` + `bonus` → "标记目标，击杀时获得额外掉落奖励"

### 10.2.4 顺序对描述的影响

顺序重排会影响描述语义：

**示例1：Target 位置影响**
- `[c1, t1, c2, a1]` → "锁定最近敌人后检查距离，发射投射物"（锁定型）
- `[c1, c2, t1, a1]` → "检查距离后选择目标，发射投射物"（非锁定型）

**示例2：Debuff 位置影响**
- `[t1, a1, a2, a3]` → "先选择目标，造成伤害，再施加减速"（伤害优先）
- `[t1, a3, a1, a2]` → "先选择目标，施加减速，再造成伤害"（控制优先）

描述生成器应识别这些顺序差异，在描述中体现（例如"先减速后伤害" vs "先伤害后减速"）。

## 10.3 ECA 拼装可视化

### 10.3.1 显示内容

编辑器应清晰展示技能的 ECA 结构：

1. **技能描述**（一句话，突出显示）
2. **模块链可视化**：
   - 显示每个模块的类型图标（C/T/A/TL）
   - 显示模块的执行顺序（1→2→3...）
   - 显示每个模块的档位选择
   - 用连线表示执行流程
3. **实时更新**：调整顺序或档位后，立即更新描述和可视化

### 10.3.2 UI 布局建议

```
┌─────────────────────────────────────┐
│ 【技能描述】                          │
│ "向最近敌人发射快速穿透弹"            │
├─────────────────────────────────────┤
│ ECA 拼装：                           │
│ [C1] → [C2] → [T1] → [A1] → [A2]   │
│ 资源  距离  目标  投射  伤害          │
│                                      │
│ 详细：                               │
│ 1. Condition: Mana≥30                │
│ 2. Condition: ≤12m                   │
│ 3. Target: 直线（最近）              │
│ 4. Action: 快弹（穿透）              │
│ 5. Action: 中伤                       │
└─────────────────────────────────────┘
```

### 10.3.3 实现要点

- **描述生成函数**：`generateSkillDescription(assembly)` → 返回一句话描述
- **可视化渲染**：根据 `order` 和 `slotOptions` 渲染模块链
- **实时更新**：`rebuildAssembly()` 时调用描述生成和可视化更新

## 10.4 随机武器系统

### 10.4.1 设计目标

每次体验（刷新怪物/新开局）时，玩家获得一把**随机生成的武器**（随机 Assembly），增加探索乐趣和重玩价值。

### 10.4.2 随机生成规则

1. **随机模板**：从所有可用模板中随机选择一个
2. **随机顺序**：对模板的 slots 进行随机重排
3. **随机档位**：为每个 slot 随机选择一个 option（可以是 defaultOption，也可以是其他 option）
4. **验证通过**：生成的 Assembly 必须通过预算校验和守卫检查

### 10.4.3 随机种子

- **每次刷新怪物时**：使用当前时间戳作为种子，生成新的随机武器
- **可复现性**：如果需要在测试时复现，可以保存种子值

### 10.4.4 UI 交互

- **"刷新怪物"按钮**：同时刷新怪物和随机武器
- **"随机武器"按钮**（可选）：只刷新武器，不刷新怪物
- **武器展示**：
  - 显示技能描述
  - 显示 ECA 拼装可视化
  - 显示"随机生成"标识

### 10.4.5 实现要点

- **随机生成函数**：`generateRandomWeapon(templates, rng)` → 返回随机 Assembly
- **初始化逻辑**：`newWorld()` 或点击"刷新怪物"时调用随机生成
- **编辑器同步**：随机生成的武器自动加载到编辑器，玩家可以在此基础上调整

## 10.5 与现有系统的对接

### 10.5.1 编辑器集成

- **技能描述区域**：在编辑器顶部显示当前 Assembly 的技能描述
- **ECA 拼装可视化**：在技能描述下方显示模块链
- **实时更新**：调整顺序或档位后，重新生成描述和可视化

### 10.5.2 战斗系统集成

- **随机武器初始化**：`newWorld()` 时生成随机武器
- **武器应用**：随机武器自动应用到战斗系统
- **武器持久化**：可选：保存当前武器到本地存储，下次加载时恢复

## 10.6 实现文件

- **描述生成**：`engine/skillDescription.js`（新增）
- **随机生成**：`engine/randomWeapon.js`（新增）
- **编辑器更新**：`editor/play.js`（修改，添加描述显示和随机生成逻辑）
- **UI 更新**：`editor/index.html`（修改，添加技能描述和 ECA 可视化区域）

## 10.7 后续扩展

- **描述模板配置化**：将描述模板从代码中提取到配置文件，便于策划调整
- **描述多语言支持**：支持中英文描述生成
- **武器收藏系统**：玩家可以收藏喜欢的随机武器
- **武器分享**：生成武器分享码，其他玩家可以导入
