# 11 丰富技能效果设计

## 11.1 设计目标

为了让随机生成的技能体验更加丰富多样，需要扩展 ECA 系统的 Action 类型，支持：
1. **多弹散射**：一次发射多个子弹，呈扇形或圆形散射
2. **连发机制**：快速连续发射多个子弹
3. **延迟爆炸**：子弹飞行一段时间后产生爆炸效果
4. **组合效果**：将上述效果组合使用

## 11.2 新增 Action 类型

### 11.2.1 SpawnMultipleProjectiles（多弹散射）

**功能**：一次发射多个子弹，呈扇形或圆形散射

**参数**：
- `count`: 子弹数量（3/5/7）
- `spreadAngle`: 散射角度（度，例如 30/60/90）
- `spreadType`: 散射类型（"fan" 扇形 / "circle" 圆形）
- `formula`: 每个子弹的伤害公式
- `projectileSpeed`: 子弹速度
- `radius`: 子弹半径

**预算影响**：
- `damage`: 每个子弹的伤害预算 × 数量
- `perf`: 性能预算（子弹数量越多，性能消耗越大）

**示例配置**：
```javascript
{
  id: "proj_scatter3",
  label: "3弹散射",
  kind: "SpawnMultipleProjectiles",
  count: 3,
  spreadAngle: 45,
  spreadType: "fan",
  formula: { scale: 0.6, flat: 20 },
  budget: { damage: 60, perf: 12 },
  presentation: { projectileSpeed: 15 }
}
```

### 11.2.2 SpawnBurstProjectiles（连发机制）

**功能**：快速连续发射多个子弹，每次发射有短暂延迟

**参数**：
- `count`: 连发数量（2/3/5）
- `burstDelay`: 每次发射之间的延迟（毫秒，例如 50/100/150）
- `formula`: 每个子弹的伤害公式
- `projectileSpeed`: 子弹速度
- `radius`: 子弹半径

**预算影响**：
- `damage`: 每个子弹的伤害预算 × 数量
- `perf`: 性能预算（连发数量越多，性能消耗越大）

**示例配置**：
```javascript
{
  id: "proj_burst3",
  label: "3连发",
  kind: "SpawnBurstProjectiles",
  count: 3,
  burstDelay: 100,
  formula: { scale: 0.65, flat: 22 },
  budget: { damage: 66, perf: 15 },
  presentation: { projectileSpeed: 16 }
}
```

### 11.2.3 SpawnProjectileWithExplosion（延迟爆炸）

**功能**：发射一个子弹，飞行指定时间或距离后产生爆炸效果

**参数**：
- `formula`: 子弹伤害公式
- `explosionFormula`: 爆炸伤害公式（通常比子弹伤害高）
- `explosionRadius`: 爆炸半径（世界单位）
- `explosionDelay`: 爆炸延迟（毫秒，例如 500/1000/1500）
- `explosionType`: 爆炸类型（"time" 时间触发 / "distance" 距离触发）
- `projectileSpeed`: 子弹速度
- `radius`: 子弹半径

**预算影响**：
- `damage`: 子弹伤害 + 爆炸伤害
- `perf`: 性能预算（爆炸效果需要额外计算）

**示例配置**：
```javascript
{
  id: "proj_explosive",
  label: "爆炸弹",
  kind: "SpawnProjectileWithExplosion",
  formula: { scale: 0.5, flat: 15 },
  explosionFormula: { scale: 1.2, flat: 40 },
  explosionRadius: 2.5,
  explosionDelay: 1000,
  explosionType: "time",
  budget: { damage: 80, perf: 18 },
  presentation: { projectileSpeed: 14 }
}
```

### 11.2.4 SpawnProjectileChain（链式子弹）

**功能**：子弹命中后，在目标位置生成新的子弹继续飞行（可选）

**参数**：
- `formula`: 子弹伤害公式
- `chainCount`: 链式次数（1/2/3）
- `chainRange`: 链式搜索范围
- `projectileSpeed`: 子弹速度

**预算影响**：
- `damage`: 基础伤害 × (1 + chainCount)
- `perf`: 性能预算（链式需要额外计算）

## 11.3 实现要点

### 11.3.1 多弹散射实现

1. 计算散射角度：根据 `spreadAngle` 和 `count` 计算每个子弹的角度偏移
2. 扇形散射：以瞄准方向为中心，均匀分布在扇形范围内
3. 圆形散射：360度均匀分布
4. 每个子弹独立计算速度和方向

### 11.3.2 连发机制实现

1. 使用 Timeline 延迟机制：每次发射后延迟 `burstDelay` 毫秒
2. 或者使用递归调度：在 Action 内部使用 `scheduleFn` 延迟下一次发射
3. 保持相同的瞄准方向

### 11.3.3 延迟爆炸实现

1. 在子弹实体上添加 `explosionAt` 字段（时间戳）
2. 在 `updateProjectiles` 中检查是否到达爆炸时间
3. 爆炸时：
   - 移除子弹实体
   - 在子弹位置创建爆炸效果
   - 对范围内的敌人造成伤害

### 11.3.4 组合效果

可以通过顺序重排实现组合效果：
- `[SpawnMultipleProjectiles, SpawnBurstProjectiles]` → 先散射，再连发
- `[SpawnProjectileWithExplosion, Damage]` → 爆炸后追加伤害
- `[SpawnMultipleProjectiles, SpawnProjectileWithExplosion]` → 散射的子弹都带爆炸

## 11.4 模板更新建议

### 11.4.1 远程投射模板扩展

在 `tpl_ranged_proj_v1` 的 `a1` 槽位中添加新选项：
- `proj_scatter3`: 3弹散射（45度扇形）
- `proj_scatter5`: 5弹散射（60度扇形）
- `proj_burst3`: 3连发（100ms间隔）
- `proj_explosive`: 爆炸弹（1秒延迟）

### 11.4.2 新增模板：爆发散射

创建新模板 `tpl_burst_scatter_v1`：
- 专门用于多弹散射和连发效果
- 槽位：资源条件 → 目标选择 → 散射/连发 → 伤害 → 控制

### 11.4.3 新增模板：爆炸专家

创建新模板 `tpl_explosive_v1`：
- 专门用于爆炸效果
- 槽位：资源条件 → 目标选择 → 爆炸弹 → 范围伤害 → 控制

## 11.5 技能描述更新

技能描述生成器需要识别新类型：
- `SpawnMultipleProjectiles` → "发射X弹散射"
- `SpawnBurstProjectiles` → "X连发"
- `SpawnProjectileWithExplosion` → "发射爆炸弹" / "延迟爆炸"

## 11.6 性能考虑

1. **子弹数量上限**：单次技能最多生成 10 个子弹
2. **爆炸范围查询**：使用简单的距离检查，避免复杂的几何计算
3. **连发延迟**：最小延迟 50ms，避免性能问题
4. **预算限制**：通过预算系统限制过度使用高性能效果

## 11.7 视觉效果建议

1. **散射子弹**：不同颜色或大小区分
2. **连发子弹**：视觉上快速连续出现
3. **爆炸效果**：圆形扩散动画，带粒子效果
4. **组合效果**：视觉上清晰展示多个效果叠加

## 11.8 扩展伤害机制

### 11.8.1 BounceDamage（弹射伤害）

**功能**：伤害在目标之间弹射，可以重复命中同一目标

**参数**：
- `formula`: 基础伤害公式
- `bounceCount`: 弹射次数（2/3/5）
- `bounceRange`: 弹射范围（世界单位）
- `damageDecay`: 每次弹射伤害衰减（0.7-0.9）
- `canBounceSelf`: 是否可以弹回自己

**预算**：`damage: 45, perf: 12`

**示例**：
```javascript
{
  id: "bounce3",
  label: "3次弹射",
  kind: "BounceDamage",
  formula: { scale: 0.7, flat: 25 },
  bounceCount: 3,
  bounceRange: 4,
  damageDecay: 0.8,
  canBounceSelf: false,
  budget: { damage: 45, perf: 12 }
}
```

### 11.8.2 PierceDamage（穿透伤害）

**功能**：伤害穿透多个目标，对路径上所有敌人造成伤害

**参数**：
- `formula`: 伤害公式
- `pierceCount`: 穿透次数（2/3/5）
- `damageDecay`: 每次穿透伤害衰减（0.8-0.95）
- `pierceWidth`: 穿透宽度（世界单位）

**预算**：`damage: 35, perf: 8`

### 11.8.3 SplitDamage（分裂伤害）

**功能**：命中后分裂成多个投射物

**参数**：
- `formula`: 基础伤害公式
- `splitCount`: 分裂数量（2/3/5）
- `splitAngle`: 分裂角度（度）
- `damageDecay`: 分裂后伤害衰减（0.6-0.8）

**预算**：`damage: 50, perf: 15`

### 11.8.4 ReflectDamage（反弹伤害）

**功能**：反弹受到的伤害

**参数**：
- `reflectPercent`: 反弹百分比（20%/35%/50%）
- `durationMs`: 持续时间
- `maxReflect`: 最大反弹伤害

**预算**：`damage: 30, cc: 15`

### 11.8.5 DelayedDamage（延迟伤害）

**功能**：延迟一段时间后造成伤害

**参数**：
- `formula`: 伤害公式
- `delayMs`: 延迟时间（500/1000/2000）
- `markVisual`: 标记视觉效果

**预算**：`damage: 35`

### 11.8.6 ExecuteDamage（处决伤害）

**功能**：目标生命值越低，伤害越高

**参数**：
- `baseFormula`: 基础伤害公式
- `executeThreshold`: 处决阈值（生命值百分比，如0.3）
- `executeMultiplier`: 处决倍率（1.5/2.0/3.0）

**预算**：`damage: 40`

### 11.8.7 BleedDamage（流血伤害）

**功能**：持续造成伤害

**参数**：
- `tickFormula`: 每次tick伤害
- `durationMs`: 持续时间
- `tickIntervalMs`: tick间隔
- `maxStacks`: 最大叠加层数

**预算**：`damage: 30, perf: 8`

### 11.8.8 CritDamage（暴击伤害）

**功能**：有概率造成额外伤害

**参数**：
- `formula`: 基础伤害公式
- `critChance`: 暴击概率（0.15/0.25/0.35）
- `critMultiplier`: 暴击倍率（1.5/2.0/2.5）

**预算**：`damage: 35, proc: 15`

## 11.9 扩展控制机制

### 11.9.1 Fear（恐惧）

**功能**：目标随机方向移动，无法控制

**参数**：
- `durationMs`: 持续时间
- `moveSpeed`: 恐惧时的移动速度
- `canAttack`: 是否可以使用技能

**预算**：`cc: 28`

### 11.9.2 Charm（魅惑）

**功能**：目标向施法者移动

**参数**：
- `durationMs`: 持续时间
- `moveSpeed`: 魅惑时的移动速度
- `canAttack`: 是否可以使用技能

**预算**：`cc: 30`

### 11.9.3 Polymorph（变形）

**功能**：将目标变形为无害形态

**参数**：
- `durationMs`: 持续时间
- `form`: 变形形态（"sheep"/"frog"/"chicken"）
- `canMove`: 是否可以移动
- `canAttack`: 是否可以使用技能

**预算**：`cc: 35`

### 11.9.4 Taunt（嘲讽）

**功能**：强制目标攻击自己

**参数**：
- `durationMs`: 持续时间
- `canMove`: 是否可以移动
- `mustAttack`: 是否必须攻击

**预算**：`cc: 25`

### 11.9.5 Blind（致盲）

**功能**：目标攻击命中率降低

**参数**：
- `durationMs`: 持续时间
- `missChance`: 未命中概率（0.3/0.5/0.7）

**预算**：`cc: 20`

### 11.9.6 Silence（沉默）

**功能**：目标无法使用技能（已实现，扩展）

**参数**：
- `durationMs`: 持续时间
- `canMove`: 是否可以移动
- `canAttack`: 是否可以使用普通攻击

**预算**：`cc: 22`

### 11.9.7 Suppress（压制）

**功能**：完全控制目标，无法做任何操作

**参数**：
- `durationMs`: 持续时间
- `canBeCleansed`: 是否可以被净化

**预算**：`cc: 40`

### 11.9.8 Sleep（睡眠）

**功能**：目标进入睡眠状态，受到伤害会醒来

**参数**：
- `durationMs`: 持续时间
- `wakeOnDamage`: 受到伤害是否醒来
- `healRate`: 睡眠时的生命恢复速度

**预算**：`cc: 25`

### 11.9.9 Ground（击倒）

**功能**：目标被击倒，无法移动和攻击

**参数**：
- `durationMs`: 持续时间
- `canBeInterrupted`: 是否可以被中断

**预算**：`cc: 30`

### 11.9.10 Banished（放逐）

**功能**：目标进入异次元，无法被选中和攻击

**参数**：
- `durationMs`: 持续时间
- `canDealDamage`: 是否可以造成伤害
- `canTakeDamage`: 是否可以受到伤害

**预算**：`cc: 35`

## 11.10 扩展增益机制

### 11.10.1 Shield（护盾）

**功能**：吸收伤害的护盾（已实现，扩展）

**参数**：
- `power`: 护盾值
- `durationMs`: 持续时间
- `canStack`: 是否可以叠加
- `decayRate`: 衰减速率（每秒）

**预算**：`cc: 5-15`（根据护盾值）

### 11.10.2 Heal（治疗）

**功能**：恢复生命值（已实现，扩展）

**参数**：
- `formula`: 治疗公式
- `isPercent`: 是否基于最大生命值百分比
- `overHeal`: 是否可以超过最大生命值
- `healOverTime`: 是否持续治疗

**预算**：`cc: 15-25`

### 11.10.3 Buff（增益）

**功能**：提升属性（已实现，扩展）

**参数**：
- `kind`: 增益类型（"atkBoost"/"defBoost"/"speedBoost"/"critBoost"/"lifesteal"/"spellVamp"）
- `power`: 增益强度
- `durationMs`: 持续时间
- `canStack`: 是否可以叠加

**预算**：`cc: 10-20`

### 11.10.4 Immunity（免疫）

**功能**：免疫特定类型的伤害或控制

**参数**：
- `immunityType`: 免疫类型（"physical"/"magic"/"true"/"cc"/"all"）
- `durationMs`: 持续时间

**预算**：`cc: 30`

### 11.10.5 Invulnerable（无敌）

**功能**：完全无敌，不受任何伤害

**参数**：
- `durationMs`: 持续时间
- `canMove`: 是否可以移动
- `canAttack`: 是否可以攻击

**预算**：`cc: 40`

### 11.10.6 Cleanse（净化）

**功能**：移除所有负面效果

**参数**：
- `removeTypes`: 移除的类型（["slow", "stun", "root"]）
- `immunityDuration`: 移除后的免疫时间

**预算**：`cc: 25`

### 11.10.7 Stealth（隐身）

**功能**：进入隐身状态

**参数**：
- `durationMs`: 持续时间
- `revealOnAttack`: 攻击时是否显形
- `revealOnDamage`: 受到伤害时是否显形
- `revealRange`: 显形范围

**预算**：`cc: 30`

### 11.10.8 Haste（急速）

**功能**：大幅提升移动速度和攻击速度

**参数**：
- `speedBoost`: 速度提升（0.3/0.5/0.7）
- `attackSpeedBoost`: 攻击速度提升（0.2/0.4/0.6）
- `durationMs`: 持续时间

**预算**：`cc: 20`

### 11.10.9 Lifesteal（生命偷取）

**功能**：造成伤害时恢复生命值

**参数**：
- `lifestealPercent`: 生命偷取百分比（0.1/0.2/0.3）
- `durationMs`: 持续时间

**预算**：`cc: 15`

### 11.10.10 SpellVamp（法术吸血）

**功能**：技能造成伤害时恢复生命值

**参数**：
- `spellVampPercent`: 法术吸血百分比（0.15/0.25/0.35）
- `durationMs`: 持续时间

**预算**：`cc: 18`

## 11.11 扩展位移机制

### 11.11.1 Blink（闪现）

**功能**：瞬间移动到目标位置

**参数**：
- `distance`: 最大距离
- `canPassWall`: 是否可穿墙
- `cooldown`: 冷却时间

**预算**：`mobility: 25`

### 11.11.2 Jump（跳跃）

**功能**：抛物线跳跃到目标位置

**参数**：
- `distance`: 水平距离
- `height`: 跳跃高度
- `duration`: 跳跃持续时间
- `landDamage`: 落地伤害（可选）

**预算**：`mobility: 30`

### 11.11.3 Pull（拉回）

**功能**：将目标拉向自己

**参数**：
- `distance`: 拉回距离
- `speed`: 拉回速度
- `canInterrupt`: 是否可以打断技能

**预算**：`cc: 20, mobility: 15`

### 11.11.4 Push（推开）

**功能**：将目标推开

**参数**：
- `distance`: 推开距离
- `speed`: 推开速度
- `canInterrupt`: 是否可以打断技能

**预算**：`cc: 18`

### 11.11.5 Teleport（传送）

**功能**：延迟后传送到目标位置

**参数**：
- `delay`: 传送延迟（毫秒）
- `maxDistance`: 最大距离
- `channelTime`: 引导时间

**预算**：`mobility: 35`

### 11.11.6 Swap（交换位置）

**功能**：与目标交换位置

**参数**：
- `range`: 交换范围
- `canSwapEnemy`: 是否可以与敌人交换

**预算**：`mobility: 30, cc: 10`

### 11.11.7 Wall（创造墙壁）

**功能**：创造一堵墙阻挡移动

**参数**：
- `length`: 墙壁长度
- `width`: 墙壁宽度
- `durationMs`: 持续时间
- `canPass`: 是否可以穿过

**预算**：`cc: 25, perf: 10`

### 11.11.8 Portal（传送门）

**功能**：创建两个传送门，可以在之间传送

**参数**：
- `portalDistance`: 传送门距离
- `durationMs`: 持续时间
- `maxUses`: 最大使用次数

**预算**：`mobility: 40, perf: 12`

## 11.12 扩展特殊机制

### 11.12.1 Mark（标记）

**功能**：标记目标，后续技能可以触发额外效果（已实现，扩展）

**参数**：
- `tag`: 标记标签
- `durationMs`: 持续时间
- `maxStacks`: 最大叠加层数
- `onHitEffect`: 命中时的额外效果

**预算**：`proc: 5-15`

### 11.12.2 Charge（蓄力）

**功能**：按住技能键蓄力，释放时根据蓄力时间产生不同效果

**参数**：
- `maxChargeTime`: 最大蓄力时间
- `minEffect`: 最小效果
- `maxEffect`: 最大效果
- `chargeVisual`: 蓄力视觉效果

**预算**：`damage: 20-50`（根据效果）

### 11.12.3 Stack（充能）

**功能**：技能可以充能多次

**参数**：
- `maxStacks`: 最大充能数
- `stackCooldown`: 每层充能冷却
- `useAllStacks`: 是否一次性使用所有充能

**预算**：`perf: 10`

### 11.12.4 Homing（追踪）

**功能**：投射物自动追踪目标

**参数**：
- `turnRate`: 转向速度
- `maxTurnAngle`: 最大转向角度
- `loseTargetRange`: 失去目标范围

**预算**：`perf: 8`

### 11.12.5 Ricochet（弹跳）

**功能**：投射物在墙壁或目标间弹跳

**参数**：
- `bounceCount`: 弹跳次数
- `bounceRange`: 弹跳范围
- `damageDecay`: 每次弹跳伤害衰减

**预算**：`damage: 40, perf: 12`

### 11.12.6 Spiral（螺旋）

**功能**：投射物螺旋飞行

**参数**：
- `spiralRadius`: 螺旋半径
- `spiralSpeed`: 螺旋速度
- `turns`: 旋转圈数

**预算**：`perf: 10`

### 11.12.7 Orbit（环绕）

**功能**：投射物围绕施法者旋转

**参数**：
- `orbitRadius`: 环绕半径
- `orbitSpeed`: 环绕速度
- `orbitCount`: 环绕数量
- `durationMs`: 持续时间

**预算**：`damage: 35, perf: 15`

### 11.12.8 Return（回旋）

**功能**：投射物飞出后返回

**参数**：
- `maxDistance`: 最大距离
- `returnSpeed`: 返回速度
- `returnDamage`: 返回时是否造成伤害

**预算**：`damage: 30, perf: 8`

### 11.12.9 DelayTrigger（延迟触发）

**功能**：延迟一段时间后触发效果

**参数**：
- `delayMs`: 延迟时间
- `triggerCondition`: 触发条件（"time"/"onHit"/"onDeath"）
- `canCancel`: 是否可以取消

**预算**：`perf: 6`

### 11.12.10 ConditionalTrigger（条件触发）

**功能**：满足条件时触发效果

**参数**：
- `condition`: 触发条件（"hpBelow"/"hpAbove"/"hasBuff"/"hasDebuff"）
- `threshold`: 阈值
- `effect`: 触发效果

**预算**：`proc: 10-20`

## 11.13 扩展区域效果

### 11.13.1 HealZone（治疗区域）

**功能**：区域内持续恢复生命值

**参数**：
- `radius`: 区域半径
- `healFormula`: 治疗公式
- `durationMs`: 持续时间
- `tickIntervalMs`: tick间隔

**预算**：`cc: 20, perf: 10`

### 11.13.2 SlowZone（减速区域）

**功能**：区域内敌人减速

**参数**：
- `radius`: 区域半径
- `slowPower`: 减速强度
- `durationMs`: 持续时间

**预算**：`cc: 15, perf: 8`

### 11.13.3 VisionZone（视野区域）

**功能**：提供视野

**参数**：
- `radius`: 视野半径
- `durationMs`: 持续时间
- `revealStealth`: 是否显形隐身单位

**预算**：`perf: 5`

### 11.13.4 BlockZone（阻挡区域）

**功能**：阻挡移动

**参数**：
- `shape`: 形状（"line"/"circle"/"rectangle"）
- `size`: 尺寸
- `durationMs`: 持续时间
- `canPass`: 是否可以穿过

**预算**：`cc: 25, perf: 10`

### 11.13.5 DamageZone（伤害区域）

**功能**：区域内持续造成伤害（已实现为SpawnAreaDoT，扩展）

**参数**：
- `radius`: 区域半径
- `tickFormula`: tick伤害公式
- `durationMs`: 持续时间
- `tickIntervalMs`: tick间隔
- `debuff`: 附加debuff（可选）

**预算**：`damage: 28-35, perf: 10-14`

### 11.13.6 BuffZone（增益区域）

**功能**：区域内友军获得增益

**参数**：
- `radius`: 区域半径
- `buff`: 增益效果
- `durationMs`: 持续时间
- `affectsAllies`: 是否影响友军

**预算**：`cc: 20, perf: 8`

## 11.14 扩展召唤机制

### 11.14.1 Summon（召唤）

**功能**：召唤一个单位

**参数**：
- `summonType`: 召唤类型（"minion"/"pet"/"clone"）
- `hp`: 生命值
- `atk`: 攻击力
- `durationMs`: 持续时间
- `ai`: AI行为（"attack"/"defend"/"follow"）

**预算**：`perf: 20`

### 11.14.2 Trap（陷阱）

**功能**：放置一个陷阱，触发时造成效果

**参数**：
- `triggerRadius`: 触发半径
- `triggerCondition`: 触发条件（"step"/"time"/"manual"）
- `effect`: 触发效果
- `durationMs`: 持续时间
- `maxTraps`: 最大陷阱数

**预算**：`damage: 30, perf: 12`

### 11.14.3 Ward（守卫）

**功能**：放置一个守卫提供视野或效果

**参数**：
- `visionRadius`: 视野半径
- `effectRadius`: 效果半径
- `effect`: 效果（"vision"/"slow"/"damage"）
- `durationMs`: 持续时间
- `maxWards`: 最大守卫数

**预算**：`perf: 8`

### 11.14.4 Turret（炮塔）

**功能**：放置一个自动攻击的炮塔

**参数**：
- `hp`: 生命值
- `atk`: 攻击力
- `attackRange`: 攻击范围
- `attackSpeed`: 攻击速度
- `durationMs`: 持续时间

**预算**：`damage: 40, perf: 15`

## 11.15 扩展目标选择机制

### 11.15.1 AllInRange（范围内所有）

**功能**：选择范围内所有敌人（已实现）

**参数**：
- `range`: 范围
- `maxCount`: 最大数量（可选）

**预算**：`perf: 8`

### 11.15.2 LowestHealth（最低生命值）

**功能**：选择生命值最低的敌人（已实现）

**参数**：
- `range`: 搜索范围
- `count`: 选择数量

**预算**：`perf: 6`

### 11.15.3 HighestHealth（最高生命值）

**功能**：选择生命值最高的敌人（已实现）

**参数**：
- `range`: 搜索范围
- `count`: 选择数量

**预算**：`perf: 6`

### 11.15.4 MarkedTargets（标记目标）

**功能**：选择带特定标记的目标（已实现）

**参数**：
- `markTag`: 标记标签
- `range`: 搜索范围

**预算**：`perf: 5`

### 11.15.5 Self（自己）

**功能**：选择自己（已实现）

**预算**：`perf: 0`

### 11.15.6 Allies（友军）

**功能**：选择友军（已实现）

**参数**：
- `range`: 搜索范围
- `maxCount`: 最大数量

**预算**：`perf: 6`

### 11.15.7 Line（直线）

**功能**：选择直线路径上的所有目标

**参数**：
- `range`: 直线长度
- `width`: 直线宽度
- `maxCount`: 最大数量

**预算**：`perf: 10`

### 11.15.8 Cone（扇形）

**功能**：选择扇形范围内的目标（已实现，扩展）

**参数**：
- `range`: 扇形范围
- `angle`: 扇形角度
- `maxCount`: 最大数量

**预算**：`perf: 8`

### 11.15.9 Circle（圆形）

**功能**：选择圆形范围内的目标（已实现，扩展）

**参数**：
- `radius`: 圆形半径
- `maxCount`: 最大数量

**预算**：`perf: 8`

### 11.15.10 RandomInRange（随机选择）

**功能**：在范围内随机选择目标

**参数**：
- `range`: 搜索范围
- `count`: 选择数量
- `weighted`: 是否加权随机

**预算**：`perf: 6`

## 11.16 扩展条件机制

### 11.16.1 HasBuff（有增益）

**功能**：检查目标是否有特定增益

**参数**：
- `buffKind`: 增益类型
- `minStacks`: 最小叠加层数

**预算**：`proc: 5`

### 11.16.2 HasDebuff（有负面效果）

**功能**：检查目标是否有特定负面效果

**参数**：
- `debuffKind`: 负面效果类型
- `minStacks`: 最小叠加层数

**预算**：`proc: 5`

### 11.16.3 HealthBelow（生命值低于）

**功能**：检查目标生命值是否低于阈值

**参数**：
- `threshold`: 阈值（百分比或绝对值）
- `isPercent`: 是否为百分比

**预算**：`proc: 3`

### 11.16.4 HealthAbove（生命值高于）

**功能**：检查目标生命值是否高于阈值

**参数**：
- `threshold`: 阈值（百分比或绝对值）
- `isPercent`: 是否为百分比

**预算**：`proc: 3`

### 11.16.5 CooldownReady（冷却就绪）

**功能**：检查技能冷却是否就绪

**参数**：
- `skillId`: 技能ID
- `cooldownMs`: 冷却时间

**预算**：`proc: 5`

### 11.16.6 EnemyCount（敌人数量）

**功能**：检查范围内敌人数量

**参数**：
- `range`: 范围
- `minCount`: 最小数量
- `maxCount`: 最大数量

**预算**：`proc: 5`

### 11.16.7 Distance（距离）

**功能**：检查与目标的距离

**参数**：
- `minDistance`: 最小距离
- `maxDistance`: 最大距离

**预算**：`proc: 3`

### 11.16.8 Facing（面向）

**功能**：检查是否面向目标

**参数**：
- `tolerance`: 容差角度（度）

**预算**：`proc: 3`

### 11.16.9 ComboCount（连击数）

**功能**：检查连击数

**参数**：
- `minCombo`: 最小连击数
- `comboWindow`: 连击窗口时间

**预算**：`proc: 8`

### 11.16.10 Resource（资源）

**功能**：检查资源是否足够（已实现为HasResource，扩展）

**参数**：
- `resource`: 资源类型（"mana"/"energy"/"rage"）
- `amount`: 所需数量
- `isPercent`: 是否为百分比

**预算**：`proc: 3`

## 11.17 实现优先级

### 第一阶段（核心机制）
1. BounceDamage（弹射伤害）
2. PierceDamage（穿透伤害）
3. ReflectDamage（反弹伤害）
4. Fear（恐惧）
5. Charm（魅惑）
6. Blink（闪现）
7. Jump（跳跃）
8. Pull（拉回）

### 第二阶段（扩展机制）
1. SplitDamage（分裂伤害）
2. ExecuteDamage（处决伤害）
3. BleedDamage（流血伤害）
4. CritDamage（暴击伤害）
5. Polymorph（变形）
6. Taunt（嘲讽）
7. Blind（致盲）
8. Suppress（压制）

### 第三阶段（高级机制）
1. Sleep（睡眠）
2. Ground（击倒）
3. Banished（放逐）
4. Immunity（免疫）
5. Invulnerable（无敌）
6. Cleanse（净化）
7. Stealth（隐身）
8. Haste（急速）

### 第四阶段（特殊机制）
1. Charge（蓄力）
2. Stack（充能）
3. Homing（追踪）
4. Ricochet（弹跳）
5. Spiral（螺旋）
6. Orbit（环绕）
7. Return（回旋）
8. Summon（召唤）

## 11.18 预算系统扩展

新增预算维度：
- `complexity`: 复杂度预算（用于限制过于复杂的组合）
- `visual`: 视觉效果预算（用于限制过多视觉效果）

## 11.19 性能优化建议

1. **对象池**：复用投射物、效果对象
2. **空间分区**：使用网格系统优化范围查询
3. **延迟计算**：非关键效果延迟计算
4. **批量处理**：批量处理相同类型的操作
5. **LOD系统**：根据距离简化视觉效果

## 11.20 平衡性考虑

1. **稀有度系统**：某些机制更稀有，需要更高预算
2. **组合限制**：某些组合被禁止或需要额外预算
3. **冷却时间**：强效机制需要更长冷却
4. **资源消耗**：强效机制消耗更多资源
5. **范围限制**：大范围效果需要更高预算

## 11.21 《魔法工艺》核心机制参考

参考《魔法工艺》（Magicraft）的模块化法术构建系统，添加以下核心机制：

### 11.21.1 Hover/Linger（悬停/滞空）

**功能**：投射物在目标位置或目标区域停留，持续造成伤害或效果

**参数**：
- `hoverDuration`: 悬停持续时间（毫秒，500/1000/2000）
- `hoverRadius`: 悬停影响半径（世界单位）
- `tickInterval`: tick间隔（毫秒，100/200/300）
- `tickFormula`: 每次tick的伤害公式
- `hoverType`: 悬停类型（"position" 固定位置 / "target" 跟随目标 / "area" 区域持续）

**预算**：`damage: 35-50, perf: 12-18`

**示例**：
```javascript
{
  id: "hover2s",
  label: "悬停2s",
  kind: "SpawnProjectile",
  formula: { scale: 0.5, flat: 15 },
  hover: {
    hoverDuration: 2000,
    hoverRadius: 2,
    tickInterval: 200,
    tickFormula: { scale: 0.3, flat: 10 },
    hoverType: "position"
  },
  budget: { damage: 45, perf: 15 }
}
```

**实现要点**：
- 投射物命中目标或到达目标位置后，在当前位置创建悬停效果
- 悬停效果定期对范围内敌人造成伤害
- 视觉上表现为投射物在原地旋转或闪烁

### 11.21.2 ChainTrigger（连携触发）

**功能**：当一个效果触发时，自动触发另一个效果

**参数**：
- `triggerEvent`: 触发事件（"onHit"/"onKill"/"onCast"/"onDamage"）
- `triggeredAction`: 被触发的动作（可以是任何Action类型）
- `triggerChance`: 触发概率（0.3/0.5/0.7/1.0）
- `maxTriggers`: 最大触发次数（-1为无限）
- `cooldown`: 触发冷却（毫秒）

**预算**：`proc: 15-25, perf: 8-12`

**示例**：
```javascript
{
  id: "chain_onhit",
  label: "命中触发",
  kind: "ChainTrigger",
  triggerEvent: "onHit",
  triggeredAction: {
    kind: "SpawnProjectile",
    formula: { scale: 0.4, flat: 12 }
  },
  triggerChance: 0.5,
  maxTriggers: 3,
  cooldown: 500,
  budget: { proc: 20, perf: 10 }
}
```

**实现要点**：
- 在Action执行后检查触发条件
- 满足条件时，在相同或相关位置执行被触发的动作
- 可以形成链式反应（A触发B，B触发C）

### 11.21.3 Sacrifice（组合消耗）

**功能**：消耗一个法术，将其效果融合到另一个法术中

**参数**：
- `sacrificeAction`: 被消耗的动作
- `fusionType`: 融合类型（"damage" 伤害叠加 / "count" 数量叠加 / "effect" 效果叠加）
- `fusionMultiplier`: 融合倍率（1.0-2.0）
- `visualEffect`: 融合视觉效果

**预算**：`damage: 40-60, perf: 10-15`

**示例**：
```javascript
{
  id: "sacrifice_scatter",
  label: "消耗散射",
  kind: "Sacrifice",
  sacrificeAction: {
    kind: "SpawnMultipleProjectiles",
    count: 3
  },
  fusionType: "count",
  fusionMultiplier: 1.5,
  budget: { damage: 50, perf: 12 }
}
```

**实现要点**：
- 检测Assembly中是否存在可消耗的动作
- 将消耗动作的效果融合到主动作中
- 消耗动作不再单独执行

### 11.21.4 MultiModifier（多重修饰叠加）

**功能**：允许一个投射物同时拥有多个修饰效果

**参数**：
- `modifiers`: 修饰器数组（["homing", "ricochet", "split"]）
- `modifierParams`: 每个修饰器的参数
- `interactionRules`: 修饰器交互规则

**预算**：`perf: 15-25`（根据修饰器数量）

**示例**：
```javascript
{
  id: "multi_mod",
  label: "多重修饰",
  kind: "SpawnProjectile",
  formula: { scale: 0.6, flat: 20 },
  modifiers: ["homing", "ricochet", "split"],
  modifierParams: {
    homing: { turnRate: 0.15 },
    ricochet: { bounceCount: 3 },
    split: { splitCount: 3, splitAngle: 60 }
  },
  budget: { damage: 45, perf: 20 }
}
```

**实现要点**：
- 投射物同时应用多个修饰器
- 修饰器按顺序执行（例如：先追踪，命中后分裂，分裂弹再弹跳）
- 需要处理修饰器之间的交互

### 11.21.5 Rotate/Orbit（旋转/环绕）- 已实现，扩展

**功能**：投射物围绕施法者旋转（已实现为Orbit，扩展为更灵活的旋转）

**扩展参数**：
- `rotateSpeed`: 旋转速度（度/秒）
- `rotateRadius`: 旋转半径（可变化）
- `rotateCount`: 旋转投射物数量（1/3/5）
- `rotatePattern`: 旋转模式（"circle" 圆形 / "spiral" 螺旋 / "figure8" 8字）

**预算**：`damage: 35-50, perf: 15-20`

### 11.21.6 Beam/Laser（光束/射线）

**功能**：持续的光束攻击，可以穿透多个目标

**参数**：
- `beamLength`: 光束长度（世界单位）
- `beamWidth`: 光束宽度（世界单位）
- `beamDuration`: 持续时间（毫秒）
- `tickInterval`: tick间隔（毫秒）
- `tickFormula`: 每次tick伤害
- `pierceCount`: 穿透次数（-1为无限）
- `canRotate`: 是否可以旋转

**预算**：`damage: 40-60, perf: 18-25`

**示例**：
```javascript
{
  id: "laser_beam",
  label: "激光束",
  kind: "Beam",
  beamLength: 15,
  beamWidth: 1,
  beamDuration: 2000,
  tickInterval: 100,
  tickFormula: { scale: 0.4, flat: 15 },
  pierceCount: -1,
  canRotate: false,
  budget: { damage: 50, perf: 20 }
}
```

### 11.21.7 DelayedTrigger（延迟触发）

**功能**：延迟一段时间后触发效果（扩展Timeline）

**参数**：
- `delayMs`: 延迟时间（毫秒）
- `triggerAction`: 触发的动作
- `triggerPosition`: 触发位置（"caster" / "target" / "hit"）
- `canCancel`: 是否可以取消

**预算**：`perf: 8-12`

### 11.21.8 ConditionalModifier（条件修饰）

**功能**：满足条件时应用修饰效果

**参数**：
- `condition`: 条件（"hpBelow"/"hpAbove"/"hasBuff"/"hasDebuff"/"enemyCount"）
- `threshold`: 阈值
- `modifier`: 满足条件时应用的修饰
- `elseModifier`: 不满足条件时的修饰（可选）

**预算**：`proc: 10-15`

### 11.21.9 Amplify（增幅）

**功能**：增强后续动作的效果

**参数**：
- `amplifyType`: 增幅类型（"damage" / "range" / "count" / "duration"）
- `amplifyPercent`: 增幅百分比（0.2/0.5/1.0）
- `duration`: 增幅持续时间（影响后续多少个动作）

**预算**：`damage: 20-40, proc: 10`

### 11.21.10 Duplicate（复制）

**功能**：复制下一个动作，使其执行两次

**参数**：
- `duplicateCount`: 复制次数（1/2/3）
- `delayBetween`: 复制之间的延迟（毫秒）
- `angleOffset`: 角度偏移（度，用于扇形复制）

**预算**：`damage: 30-50, perf: 12-18`

## 11.22 《魔法工艺》机制实现优先级

### 第一阶段（核心机制）
1. **Hover/Linger（悬停）**：投射物停留造成持续伤害
2. **ChainTrigger（连携触发）**：效果触发效果
3. **Beam/Laser（光束）**：持续穿透攻击
4. **MultiModifier（多重修饰）**：同时应用多个修饰器

### 第二阶段（高级机制）
1. **Sacrifice（组合消耗）**：法术融合
2. **DelayedTrigger（延迟触发）**：延迟触发效果
3. **Amplify（增幅）**：增强后续动作
4. **Duplicate（复制）**：复制动作执行

### 第三阶段（特殊机制）
1. **ConditionalModifier（条件修饰）**：条件触发修饰
2. **Rotate扩展**：更灵活的旋转模式
3. **Beam旋转**：可旋转的光束
