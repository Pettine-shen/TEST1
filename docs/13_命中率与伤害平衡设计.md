# 13 命中率与伤害平衡设计

## 13.1 设计目标

建立命中难度与伤害的平衡关系：
- **高命中率技能**（快速、大范围、即时生效）→ **低伤害**
- **低命中率技能**（慢速、小范围、延迟生效）→ **高伤害**

## 13.2 影响命中率的因素

### 13.2.1 施法前摇（Windup）
- **作用**：给敌人反应时间，前摇越长，敌人越容易躲避
- **影响**：前摇每增加 100ms，命中难度 +0.1
- **范围**：0ms（即时）到 500ms（长前摇）

### 13.2.2 子弹速度（Projectile Speed）
- **作用**：子弹飞行速度，速度越慢，敌人越容易躲避
- **影响**：速度每降低 1 单位/秒，命中难度 +0.05
- **基准速度**：12 单位/秒（中等速度）
- **范围**：6（极慢）到 24（极快）

### 13.2.3 生效延迟（Delay）
- **作用**：技能释放到生效的延迟，延迟越长，敌人越容易躲避
- **影响**：延迟每增加 100ms，命中难度 +0.15
- **范围**：0ms（即时）到 500ms（长延迟）

### 13.2.4 目标范围大小
- **作用**：范围越大，命中率越高
- **影响**：
  - 单体目标：命中难度 +0.3
  - 小范围（3个目标）：命中难度 +0.1
  - 中范围（5个目标）：命中难度 0
  - 大范围（圆形/扇形）：命中难度 -0.2

### 13.2.5 投射物大小
- **作用**：投射物半径越大，命中率越高
- **影响**：半径每增加 0.1，命中难度 -0.05
- **范围**：0.2（极小）到 0.5（极大）

## 13.3 命中难度计算公式

```
命中难度 = 
  (前摇ms / 1000) * 0.1 +
  (12 - 子弹速度) / 12 * 0.3 +
  (延迟ms / 1000) * 0.15 +
  目标范围修正 +
  投射物大小修正
```

**命中难度范围**：-0.5（极易命中）到 +1.5（极难命中）

## 13.4 伤害倍率计算公式

```
伤害倍率 = 1.0 + 命中难度 * 0.8
```

**伤害倍率范围**：
- 极易命中（难度 -0.5）：0.6倍（低伤害）
- 中等命中（难度 0）：1.0倍（标准伤害）
- 极难命中（难度 +1.5）：2.2倍（高伤害）

## 13.5 平衡规则应用

### 13.5.1 快速技能（高命中率）
- **特征**：前摇 ≤100ms，子弹速度 ≥18，无延迟
- **伤害倍率**：0.6 - 0.8倍
- **示例**：
  - 前摇 50ms，速度 20，无延迟 → 倍率 0.65
  - 伤害公式：`{ scale: 0.7 * 0.65 = 0.455, flat: 25 * 0.65 = 16.25 }`

### 13.5.2 中等技能（中等命中率）
- **特征**：前摇 150-250ms，子弹速度 12-15，延迟 0-150ms
- **伤害倍率**：0.9 - 1.1倍
- **示例**：
  - 前摇 200ms，速度 12，延迟 0 → 倍率 1.0
  - 伤害公式：`{ scale: 0.7, flat: 25 }`

### 13.5.3 慢速技能（低命中率）
- **特征**：前摇 ≥300ms，子弹速度 ≤10，延迟 ≥200ms
- **伤害倍率**：1.3 - 2.2倍
- **示例**：
  - 前摇 400ms，速度 8，延迟 300ms → 倍率 1.85
  - 伤害公式：`{ scale: 0.7 * 1.85 = 1.295, flat: 25 * 1.85 = 46.25 }`

### 13.5.4 范围技能平衡
- **大范围技能**（扇形/圆形）：
  - 命中难度 -0.2
  - 伤害倍率降低 0.16（约 15%）
  - 但可以命中多个目标，总伤害可能更高

- **散射技能**：
  - 每个子弹独立计算命中难度
  - 但总伤害需要分摊到多个子弹
  - 例如：3弹散射，每个子弹伤害 = 基础伤害 / 3 * 命中倍率

## 13.6 数值调整指南

### 13.6.1 快速弹（proj_fast）
- **当前**：前摇 200ms，速度 18，伤害 { scale: 0.7, flat: 25 }
- **调整**：
  - 前摇降至 100ms（提高命中率）
  - 速度保持 18（快速）
  - 伤害降至 { scale: 0.45, flat: 16 }（降低伤害）

### 13.6.2 慢速弹（proj_slow）
- **新增选项**：
  - 前摇 400ms（长前摇）
  - 速度 8（慢速）
  - 延迟 200ms（延迟生效）
  - 伤害 { scale: 1.3, flat: 46 }（高伤害）

### 13.6.3 散射技能
- **3弹散射**：
  - 每个子弹：前摇 200ms，速度 12，伤害 { scale: 0.4, flat: 14 }
  - 总伤害：{ scale: 1.2, flat: 42 }（3个子弹）
  - 命中难度：中等（范围优势抵消部分难度）

- **5弹散射**：
  - 每个子弹：前摇 200ms，速度 12，伤害 { scale: 0.35, flat: 12 }
  - 总伤害：{ scale: 1.75, flat: 60 }（5个子弹）
  - 命中难度：较低（大范围优势）

### 13.6.4 爆炸弹
- **当前**：速度 14，延迟 1000ms，伤害 { scale: 0.5, flat: 15 }，爆炸 { scale: 1.2, flat: 40 }
- **调整**：
  - 速度降至 10（降低命中率）
  - 延迟保持 1000ms（长延迟）
  - 子弹伤害：{ scale: 0.4, flat: 12 }（降低）
  - 爆炸伤害：{ scale: 1.5, flat: 55 }（提高，因为范围大但延迟长）

## 13.7 模板级平衡

### 13.7.1 远程投射模板（tpl_ranged_proj_v1）
- **默认前摇**：200ms → 150ms（提高命中率）
- **默认速度**：12 → 10（降低命中率，平衡前摇）
- **默认伤害**：保持中等水平

### 13.7.2 近战爆发模板（tpl_melee_burst_v1）
- **默认前摇**：150ms（快速）
- **伤害**：较高（近战风险高，但命中率高）
- **范围**：小范围（扇形），命中难度 +0.1

### 13.7.3 地面持续模板（tpl_ground_dot_v1）
- **默认前摇**：250ms（较长）
- **范围**：大范围（圆形），命中难度 -0.2
- **伤害**：持续伤害，单次伤害较低，但总伤害高

## 13.8 实现建议

### 13.8.1 自动平衡系统（可选）
创建一个函数，根据技能参数自动计算伤害倍率：

```javascript
function calculateHitDifficulty(presentation, targetOp, projectileRadius) {
  const windupPenalty = (presentation.windupMs || 200) / 1000 * 0.1;
  const speedPenalty = (12 - (presentation.projectileSpeed || 12)) / 12 * 0.3;
  const delayPenalty = (presentation.delayMs || 0) / 1000 * 0.15;
  
  let rangeBonus = 0;
  if (targetOp) {
    if (targetOp.kind === "circle" || targetOp.kind === "cone") {
      rangeBonus = -0.2; // 大范围
    } else if (targetOp.max > 3) {
      rangeBonus = -0.1; // 中范围
    } else {
      rangeBonus = 0.1; // 小范围
    }
  } else {
    rangeBonus = 0.3; // 单体
  }
  
  const sizeBonus = ((projectileRadius || 0.3) - 0.3) / 0.1 * -0.05;
  
  return windupPenalty + speedPenalty + delayPenalty + rangeBonus + sizeBonus;
}

function calculateDamageMultiplier(hitDifficulty) {
  return 1.0 + hitDifficulty * 0.8;
}
```

### 13.8.2 手动平衡（当前方案）
直接在模板配置中手动调整数值，确保符合平衡规则。

## 13.9 平衡验证

### 13.9.1 DPS 计算
考虑命中率后的期望 DPS：

```
期望DPS = (基础伤害 * 伤害倍率 * 命中率) / (前摇 + 后摇 + 冷却)
```

### 13.9.2 命中率估算
- **快速技能**：命中率 80-90%
- **中等技能**：命中率 50-70%
- **慢速技能**：命中率 20-40%

### 13.9.3 平衡目标
确保不同难度的技能，在考虑命中率后的期望 DPS 相近：
- 快速技能：低伤害 × 高命中率 ≈ 中等 DPS
- 慢速技能：高伤害 × 低命中率 ≈ 中等 DPS

## 13.10 后续优化

1. **动态平衡**：根据实际命中率数据调整倍率
2. **玩家技能**：高技能玩家使用慢速技能命中率更高，需要额外平衡
3. **怪物AI**：不同AI难度影响命中率，需要调整
4. **环境因素**：地形、障碍物影响命中率
