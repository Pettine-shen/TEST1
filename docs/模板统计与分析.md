# 模板统计与分析

## 模板位置

**文件路径**：`configs/templates.js`

**导出方式**：`export const templates = [...]`

---

## 模板数量统计

**总模板数**：**5套**

### 模板列表

1. **tpl_ranged_proj_v1**（远程投射物模板）
2. **tpl_melee_burst_v1**（近战爆发模板）
3. **tpl_counter_v1**（反击模板）
4. **tpl_ground_dot_v1**（地面持续伤害模板）
5. **tpl_mark_exec_v1**（标记处决模板）

---

## 各模板详细统计

### 1. tpl_ranged_proj_v1（远程投射物模板）

**事件类型**：`CastConfirm`

**槽位数量**：7个

**槽位配置**：
- `c1` (Condition): **2个选项** (mana30, ammo1)
- `c2` (Condition): **2个选项** (range12, range18)
- `t1` (Target): **5个选项** (line, coneS, coneW, allRange, lowestHp)
- `a1` (Action): **12个选项** (proj_fast, proj_pierce, proj_slow, proj_scatter3, proj_scatter5, proj_burst3, proj_explosive, proj_hover, proj_hover_long, beam_short, beam_long)
- `a2` (Action): **20个选项** (dmg_mid, dmg_high, percent5, percent8, true_dmg, chain3, bounce3, pierce3, reflect20, split3, execute, bleed, crit25, homing, ricochet3, spiral, orbit3, return, charge, stack3, summon_minion)
- `a3` (Action): **22个选项** (slow_light, vuln10, root_short, disarm_short, heal_light, atk_boost20, speed_boost15, fear_short, charm_short, polymorph, taunt, blind, suppress, sleep, ground, banished, immunity, invulnerable, cleanse, stealth, haste, charge, stack3, summon_minion)
- `tl1` (Timeline): **3个选项** (no_delay, windup, windup_long)

**基础组合数**：2 × 2 × 5 × 12 × 20 × 22 × 3 = **316,800种**

**多样性评分**：⭐⭐⭐⭐⭐（非常高）

---

### 2. tpl_melee_burst_v1（近战爆发模板）

**事件类型**：`CastConfirm`

**槽位数量**：7个

**槽位配置**：
- `c1` (Condition): **1个选项** (range4) ⚠️ **只有1个选项**
- `a1` (Action): **5个选项** (dash_none, dash5, blink5, jump5, pull3)
- `a2` (Action): **5个选项** (cone_hit, line_thrust, charge, stack3, summon_minion)
- `a3` (Action): **2个选项** (berserk, shield)
- `a4` (Action): **2个选项** (knockback, ministun)
- `tl1` (Timeline): **2个选项** (root05, slow1)
- `tl2` (Timeline): **2个选项** (recovery02, recovery04)

**基础组合数**：1 × 5 × 5 × 2 × 2 × 2 × 2 = **400种**

**多样性评分**：⭐⭐（较低）

**问题**：
- `c1` 槽位只有1个选项，无法变化
- 多个槽位选项数量较少（2个），容易重复

---

### 3. tpl_counter_v1（反击模板）

**事件类型**：`OnDamaged`

**槽位数量**：6个

**槽位配置**：
- `c1` (Condition): **2个选项** (proc20, proc35)
- `a1` (Action): **1个选项** (pulse) ⚠️ **只有1个选项**
- `a2` (Action): **4个选项** (silence, slow, root, disarm)
- `a3` (Action): **4个选项** (dmg_light, dmg_mid, percent6, chain2)
- `a4` (Action): **2个选项** (overheat, selfroot)
- `tl1` (Timeline): **2个选项** (delay0, delay150)

**基础组合数**：2 × 1 × 4 × 4 × 2 × 2 = **128种**

**多样性评分**：⭐（很低）

**问题**：
- `a1` 槽位只有1个选项，完全固定
- 基础组合数只有128种，非常容易重复

---

### 4. tpl_ground_dot_v1（地面持续伤害模板）

**事件类型**：`CastConfirm`

**槽位数量**：5个

**槽位配置**：
- `c1` (Condition): **1个选项** (mana25) ⚠️ **只有1个选项**
- `t1` (Target): **2个选项** (r3, r4)
- `a1` (Action): **2个选项** (area4s, area6s)
- `a2` (Action): **2个选项** (slow15, healcut)
- `tl1` (Timeline): **2个选项** (noDelay, delay300)

**基础组合数**：1 × 2 × 2 × 2 × 2 = **16种**

**多样性评分**：⭐（极低）

**问题**：
- `c1` 槽位只有1个选项，无法变化
- 基础组合数只有16种，**极易重复**

---

### 5. tpl_mark_exec_v1（标记处决模板）

**事件类型**：`CastConfirm`

**槽位数量**：6个

**槽位配置**：
- `c1` (Condition): **2个选项** (monsterOnly, any)
- `t1` (Target): **1个选项** (single) ⚠️ **只有1个选项**
- `a1` (Action): **1个选项** (mark) ⚠️ **只有1个选项**
- `a2` (Action): **1个选项** (bonus) ⚠️ **只有1个选项**
- `a3` (Action): **2个选项** (lightDmg, noDmg)
- `tl1` (Timeline): **1个选项** (noDelay) ⚠️ **只有1个选项**

**基础组合数**：2 × 1 × 1 × 1 × 2 × 1 = **4种**

**多样性评分**：⭐（极低）

**问题**：
- **4个槽位只有1个选项**，几乎完全固定
- 基础组合数只有4种，**几乎必然重复**

---

## 重复问题分析

### 问题总结

1. **模板数量少**：只有5套模板，选择范围有限

2. **部分模板选项极少**：
   - `tpl_mark_exec_v1`：只有4种基础组合，**几乎必然重复**
   - `tpl_ground_dot_v1`：只有16种基础组合，**极易重复**
   - `tpl_counter_v1`：只有128种基础组合，**容易重复**

3. **固定槽位过多**：
   - `tpl_mark_exec_v1`：4个槽位只有1个选项
   - `tpl_ground_dot_v1`：1个槽位只有1个选项
   - `tpl_counter_v1`：1个槽位只有1个选项
   - `tpl_melee_burst_v1`：1个槽位只有1个选项

### 重复概率计算

假设每个模板被选中的概率相等（1/5 = 20%），那么：

- **tpl_mark_exec_v1**：选中后，4种组合，重复概率 = **25%**
- **tpl_ground_dot_v1**：选中后，16种组合，重复概率 = **6.25%**
- **tpl_counter_v1**：选中后，128种组合，重复概率 = **0.78%**
- **tpl_melee_burst_v1**：选中后，400种组合，重复概率 = **0.25%**
- **tpl_ranged_proj_v1**：选中后，316,800种组合，重复概率 ≈ **0%**

**综合重复概率**（假设最近50次生成）：
- 如果最近50次中有10次是 `tpl_mark_exec_v1`，重复概率 = **25% × 20% = 5%**
- 如果最近50次中有10次是 `tpl_ground_dot_v1`，重复概率 = **6.25% × 20% = 1.25%**

---

## 解决方案建议

### 1. 增加模板数量（推荐）

**目标**：至少增加到 **10-15套模板**

**建议新增模板类型**：
- 持续伤害模板（DoT）
- 控制链模板（CC Chain）
- 爆发模板（Burst）
- 支援模板（Support）
- 位移模板（Mobility）
- 召唤模板（Summon）
- 混合模板（Hybrid）

### 2. 扩展现有模板的选项（推荐）

**优先级**：
1. **tpl_mark_exec_v1**：为固定槽位增加选项
   - `t1`：增加更多目标选择选项
   - `a1`：增加不同类型的标记选项
   - `a2`：增加不同类型的奖励选项
   - `tl1`：增加延迟选项

2. **tpl_ground_dot_v1**：为固定槽位增加选项
   - `c1`：增加更多资源条件选项

3. **tpl_counter_v1**：为固定槽位增加选项
   - `a1`：增加不同类型的反击效果选项

4. **tpl_melee_burst_v1**：为固定槽位增加选项
   - `c1`：增加更多距离条件选项

### 3. 调整模板选择权重（临时方案）

**方案**：降低低多样性模板的选择权重

```javascript
// 在 randomWeapon.js 中调整模板权重
const templateDiversityWeights = {
  "tpl_ranged_proj_v1": 1.0,      // 高多样性，正常权重
  "tpl_melee_burst_v1": 0.8,      // 中等多样性，降低权重
  "tpl_counter_v1": 0.5,          // 低多样性，大幅降低权重
  "tpl_ground_dot_v1": 0.3,       // 极低多样性，极低权重
  "tpl_mark_exec_v1": 0.2,        // 极低多样性，极低权重
};
```

### 4. 增强重复检测（临时方案）

**方案**：对低多样性模板使用更严格的重复检测

```javascript
// 对低多样性模板，检查最近100次而不是50次
const lowDiversityTemplates = ["tpl_mark_exec_v1", "tpl_ground_dot_v1", "tpl_counter_v1"];
const checkRange = lowDiversityTemplates.includes(template.id) ? 100 : 50;
```

---

## 结论

**是的，模板数量少和部分模板选项极少是导致随机生成大量重复的主要原因。**

**核心问题**：
1. 只有5套模板，选择范围有限
2. `tpl_mark_exec_v1` 只有4种组合，几乎必然重复
3. `tpl_ground_dot_v1` 只有16种组合，极易重复
4. `tpl_counter_v1` 只有128种组合，容易重复

**建议优先级**：
1. **立即**：扩展低多样性模板的选项（特别是 `tpl_mark_exec_v1`）
2. **短期**：增加新的模板类型
3. **中期**：调整模板选择权重，降低低多样性模板的选择概率
