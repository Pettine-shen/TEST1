# 随机武器生成规则文档

本文档详细说明随机武器生成的完整规则和流程。

## 目录

1. [概述](#概述)
2. [生成流程](#生成流程)
3. [核心规则详解](#核心规则详解)
4. [重复检测机制](#重复检测机制)
5. [效果系统](#效果系统)
6. [参数配置](#参数配置)

---

**文档状态**：已更新（2026-01-14）  
**当前实现**：动态ECA生成系统（不再使用固定模板）

---

## 概述

随机武器生成系统负责为每次游戏体验生成独特的技能组合。系统通过多层规则确保：
- **多样性**：避免重复和单调
- **有效性**：确保生成的技能组合有实际价值
- **平衡性**：通过预算系统控制技能强度

### 关键参数

- **最大尝试次数**：`maxAttempts = 100`
- **最近武器记录数**：`MAX_RECENT_WEAPONS = 50`
- **完全随机概率**：`70%`
- **表现参数波动范围**：`40%`

### 生成系统

- **生成方式**：动态ECA生成系统（不再使用固定模板）
- **生成位置**：`engine/randomWeapon.js` - `generateDynamicTemplate()`
- **规则配置**：`configs/ecaRules.js` - ECA规则池
- **性格系统**：`configs/skillPersonalities.js` - 技能性格和策略维度

**系统特点**：
- 完全动态生成技能结构，不受固定模板限制
- 根据复杂度配置动态确定槽位数量
- 根据技能性格调整动作权重
- 应用关联性约束确保技能有效性

---

## 生成流程

### 流程图

```
开始
  ↓
1. 初始化随机种子
  ↓
2. 选择技能性格（8种性格之一）
  ↓
3. 选择策略维度（伤害vs控制、安全vs风险等）
  ↓
4. 选择事件类型（CastConfirm/OnDamaged）
  ↓
5. 根据复杂度动态生成槽位结构
  - 确定动作、条件、目标、时间线槽位数量
  ↓
6. 根据性格和策略调整动作权重
  ↓
7. 生成槽位选项（从ECA规则池中选择）
  ↓
8. 随机重排槽位顺序
  ↓
9. 第一遍：选择所有选项（70%完全随机，30%轻微加权）
  ↓
10. 第二遍：检查并应用耦合关系
  ↓
11. 检查选项组合重复
  ↓
12. 应用表现参数波动（40%波动范围）
  ↓
13. 检查协同收益
  ↓
14. 编译Assembly并检查预算
  ↓
15. 检查最终重复
  ↓
16. 生成技能描述
  ↓
17. 记录到最近武器列表
  ↓
返回武器对象
```

---

## 核心规则详解

### 1. 随机种子生成

**规则**：
```javascript
baseSeed = 时间戳 + 随机数(0-1000000) + 最近武器数量
```

**目的**：确保每次生成的随机性，避免固定模式。

---

### 2. 技能性格和策略维度选择

#### 2.1 技能性格选择

**性格类型**（8种）：
- **激进型**：高伤害、高风险，追求极致输出
- **防御型**：护盾、恢复、控制，注重生存
- **战术型**：控制、标记、处决，注重策略
- **机动型**：位移、快速、灵活，注重机动性
- **范围型**：大范围、持续伤害，注重范围控制
- **单体型**：高单体伤害、穿透，注重单体爆发
- **辅助型**：增益、减益、召唤，注重团队支持
- **混合型**：多种效果组合，平衡发展

**选择方式**：完全随机选择（每种性格权重相等）

**影响**：性格会影响动作选项的权重，确保生成的技能有明显的"性格"特征

#### 2.2 策略维度选择

**维度类型**（4个维度，9种策略）：
- **伤害vs控制**：纯输出、纯控制、混合
- **安全vs风险**：安全型、风险型
- **单体vs范围**：单体、范围
- **爆发vs持续**：爆发型、持续型

**选择方式**：完全随机选择

**影响**：策略维度进一步调整动作权重，明确技能定位

**目的**：避免模板过度重复，同时优先选择高多样性模板。

---

### 3. 动态槽位结构生成

#### 3.1 复杂度配置

**配置位置**：`configs/ecaRules.js` - `COMPLEXITY_CONFIG`

**关键参数**：
- `overall`: 整体复杂度（0-1）
- `slotCount`: 槽位数量范围
- `actionCount`: 动作数量范围
- `conditionCount`: 条件数量范围
- `targetCount`: 目标数量范围
- `timelineCount`: 时间线数量范围

#### 3.2 槽位生成规则

1. **根据复杂度确定各类型槽位数量**
2. **从ECA规则池中选择选项**：
   - `EVENT_RULES`: 事件规则池
   - `CONDITION_RULES`: 条件规则池
   - `TARGET_RULES`: 目标规则池
   - `ACTION_RULES`: 动作规则池
   - `TIMELINE_RULES`: 时间线规则池
3. **应用性格和策略权重调整**
4. **应用复杂度权重过滤**（复杂动作权重降低）

### 4. 槽位顺序重排

**规则**：使用 Fisher-Yates 洗牌算法随机重排所有槽位。

**影响**：槽位顺序影响技能执行顺序，从而影响技能效果。

---

### 5. 选项选择规则

#### 4.1 选择模式

**70%概率**：完全随机选择（最大化多样性）

**30%概率**：轻微加权选择（避免最差的选项）

#### 4.2 轻微加权规则

**降低权重的选项**（权重 = `0.7`）：
- `proj_fast`（快弹）
- `dmg_mid`（中伤）
- `slow_light`（轻减速）
- `mana30`（Mana≥30）
- `range12`（≤12m）

**其他选项**：权重 = `1.0`（正常）

**目的**：略微降低基础选项的出现频率，但不完全排除。

---

### 5. 耦合关系检查和应用

#### 5.1 检查时机

在完成第一遍选项选择后，进行第二遍检查。

#### 5.2 检查流程

1. **重新构建效果列表**：从所有已选择的选项中提取效果ID
2. **遍历每个选项**：检查其效果是否需要依赖效果
3. **检查耦合关系**：调用 `checkCouplingRequirement()` 判断是否需要补充依赖
4. **应用耦合关系**：
   - 根据权重（weight）决定是否应用
   - 在后续的Action槽位中寻找匹配的依赖效果
   - 如果找到，替换选项以满足耦合关系

#### 5.3 耦合关系示例

- **反击（counter）** → 需要：恢复、护盾、生命偷取（权重：0.8）
- **处决伤害（execute）** → 需要：减速、定身、眩晕（权重：0.75）
- **区域持续伤害（areaDoT）** → 需要：减速、定身、拉回（权重：0.8）
- **突进（dash）** → 需要：护盾、无敌、恢复（权重：0.7）

**详细规则**：参见 `docs/效果耦合关系系统设计.md`

---

### 6. 重复检测机制

#### 6.1 选项组合重复检测

**检测范围**：最近50次生成的武器（`MAX_RECENT_WEAPONS = 50`）

**检测方法**：
- 将选项ID排序后拼接成字符串：`Object.values(slotOptions).sort().join("|")`
- 检查是否与最近生成的组合重复

**处理**：
- 如果重复且尝试次数 < `maxAttempts - 30`，重新生成

#### 6.2 最终重复检测

**检测范围**：所有最近生成的武器（`MAX_RECENT_WEAPONS = 50`）

**检测方法**：
- 生成选项组合签名：`Object.values(slotOptions).sort().join("|")`
- 检查是否与最近生成的武器重复

**处理**：
- 如果重复且尝试次数 < `maxAttempts - 30`，重新生成

**目的**：确保生成的技能组合有足够的多样性，避免重复。

---

### 7. 表现参数波动

#### 7.1 应用范围

**仅应用于**：
- 已选择的选项
- Action类型的选项（`SpawnProjectile`, `SpawnMultipleProjectiles`, `SpawnBurstProjectiles`, `SpawnProjectileWithExplosion`, `Damage`, `AreaDamage`）

#### 7.2 波动范围

**波动幅度**：`40%`（±20%）

**影响的参数**：
- `windupMs`（施法前摇）
- `projectileSpeed`（投射物速度）
- `recoveryMs`（后摇）

**目的**：增加技能的手感变化，提高多样性。

---

### 8. 协同收益检查和应用

#### 8.1 检查时机

在应用表现参数波动后，编译Assembly前。

#### 8.2 检查流程

1. **提取效果ID**：使用 `extractEffectIds()` 提取所有效果ID
2. **检查协同组合**：调用 `checkAllSynergies()` 查找所有匹配的协同组合
3. **计算协同收益**：汇总所有协同组合的预算加成
4. **应用协同收益**：
   - 先尝试编译Assembly
   - 如果预算超限，才应用协同收益增加预算上限
   - 如果编译成功，不修改预算上限

**目的**：只在必要时应用协同收益，避免过度放宽预算限制。

#### 8.3 协同收益示例

- **穿透+弹跳**：`damage +10, perf +5`
- **减速+定身**：`cc +15`
- **流血+处决**：`damage +20`
- **追踪+螺旋**：`damage +12, perf +6`

**详细规则**：参见 `engine/synergy.js`

---

### 9. Assembly编译和预算检查

#### 9.1 编译流程

1. 使用修改后的模板（包含表现参数波动）
2. 使用选择的槽位顺序
3. 使用选择的选项
4. 调用 `compileAssembly()` 编译

#### 9.2 预算检查

**预算类型**：
- `damage`（伤害）
- `cc`（控制）
- `mobility`（移动）
- `proc`（触发）
- `perf`（性能）

**处理**：如果预算超限，编译失败，重新生成。

---

### 10. 技能描述生成

**规则**：调用 `generateSkillDescription()` 生成一句话技能描述。

**失败处理**：如果生成失败，使用默认描述 "随机技能"。

---

### 11. 记录到最近武器列表

#### 11.1 武器签名

**格式**：`${templateId}-${order.join("-")}-${Object.values(slotOptions).join("-")}`

**目的**：唯一标识每个生成的武器。

#### 11.2 记录规则

- 添加到 `recentWeapons` 数组末尾
- 如果数组长度 > `MAX_RECENT_WEAPONS`，移除最旧的武器

---

## 重复检测机制

### 两级重复检测

1. **选项组合重复检测**（第11步）
   - 范围：最近50次生成的武器
   - 阈值：`attempts < maxAttempts - 30`
   - 签名：`Object.values(slotOptions).sort().join("|")`

2. **最终重复检测**（第15步）
   - 范围：所有最近生成的武器（`MAX_RECENT_WEAPONS = 50`）
   - 阈值：`attempts < maxAttempts - 30`
   - 签名：`Object.values(slotOptions).sort().join("|")`

### 重复检测的签名生成

**选项组合签名**：
```javascript
Object.values(slotOptions).sort().join("|")
```

**武器签名**：
```javascript
`${templateId}-${order.join("-")}-${Object.values(slotOptions).join("-")}`
```

---

## 6. 效果系统

### 6.1 技能性格系统

**配置位置**：`configs/skillPersonalities.js` - `SKILL_PERSONALITIES`

**作用**：
- 为每个技能定义明确的"性格标签"
- 通过动作权重调整确保生成的技能有明显的特色
- 影响视觉风格（投射物颜色、武器颜色）

**性格类型**：见 [技能性格和策略维度选择](#2-技能性格和策略维度选择)

### 6.2 策略维度系统

**配置位置**：`configs/skillPersonalities.js` - `STRATEGY_DIMENSIONS`

**作用**：
- 定义技能的策略定位
- 进一步调整动作权重
- 明确技能在不同维度上的定位

### 6.3 协同收益系统（Synergy）

**定义**：效果组合有"叠加收益"，但可以独立存在。

**应用时机**：编译Assembly前，仅在预算超限时应用。

**详细规则**：参见 `engine/synergy.js` 和 `docs/效果耦合关系系统设计.md`

### 6.4 耦合关系系统（Coupling）

**定义**：效果组合有"强依赖关系"，缺少依赖效果会导致技能有效性大幅下降。

**应用时机**：第一遍选项选择后，第二遍检查时应用。

**应用方式**：根据权重（weight）决定是否替换后续槽位的选项以满足依赖。

**详细规则**：参见 `engine/coupling.js` 和 `docs/效果耦合关系系统设计.md`

---

## 参数配置

### 核心参数

| 参数 | 值 | 说明 |
|------|-----|------|
| `maxAttempts` | 100 | 最大尝试次数 |
| `MAX_RECENT_WEAPONS` | 50 | 最近武器记录数 |
| `usePureRandom` | 0.7 | 完全随机概率（70%） |
| `variance` | 0.4 | 表现参数波动范围（40%） |

### 选项选择权重

| 选项类型 | 权重 | 说明 |
|---------|------|------|
| 基础选项 | 0.7 | 降低权重（proj_fast, dmg_mid等） |
| 其他选项 | 1.0 | 正常权重 |

### 重复检测阈值

| 检测类型 | 阈值 | 说明 |
|---------|------|------|
| 选项组合检测 | `maxAttempts - 30` | 标准检测 |
| 最终检测 | `maxAttempts - 30` | 标准检测 |

### 技能性格权重

| 性格类型 | 权重 | 说明 |
|---------|------|------|
| 所有性格 | 1.0 | 完全随机选择（权重相等） |

---

## 失败处理

### 所有尝试失败后

如果所有 `maxAttempts` 次尝试都失败，系统会：

1. 使用完全随机的方式选择模板
2. 随机重排槽位顺序
3. 使用加权随机选择选项（`selectWeightedOption()`）
4. 编译Assembly
5. 生成描述
6. 返回基本随机武器

**注意**：此时不再进行重复检测和耦合关系检查，确保能够返回一个武器。

---

## 调试信息

系统会在以下情况输出日志：

1. **耦合关系应用**：
   ```
   Applied coupling: {effectId} requires {dependencies}, adjusted {slotId} to {optionId}
   Applied {count} coupling adjustments
   ```

2. **表现参数波动**：
   ```
   Applied presentation variance to selected option {optionId}: {params}
   ```

3. **重复检测**：
   ```
   Skipping duplicate option combination: {signature}
   ```

4. **编译失败**：
   ```
   Assembly compilation failed, retrying: {error}
   Failed to generate unique weapon after {maxAttempts} attempts
   ```

---

## 总结

随机武器生成系统通过多层规则确保生成的技能组合：

1. **多样性**：通过动态生成、技能性格系统、选项随机选择、重复检测保证
2. **有效性**：通过耦合关系系统确保关键效果有必要的支持
3. **平衡性**：通过预算系统和协同收益系统控制强度
4. **手感变化**：通过表现参数波动增加变化
5. **差异化**：通过技能性格系统确保技能有明显的特色

系统设计兼顾了随机性和有效性，确保玩家每次体验都能获得独特且有效的技能组合。
