# 06 轻量编辑器与数据导出（参考 Noita/魔法工艺）

## 设计原则（参考 Noita 的魔杖编辑界面）
编辑器必须足够轻量，满足"玩家可用"而不是"策划专业工具"：
- **技能描述生成**：根据 Assembly 自动生成一句话技能描述，帮助玩家快速理解能力
- **ECA 拼装可视化**：清晰展示模块类型和执行顺序，调整后实时更新描述
- **随机武器系统**：每次体验获得不同的随机技能，增加探索乐趣
- **只做顺序重排**：模块卡片拖拽重排（参考 Noita 的拖拽调整法术顺序）
- **只做档位切换**：每模块点击展开档位选择（参考 Noita 的法术参数调整）
- **实时反馈**：展示导出的 Assembly（以及预算、施法体验摘要、技能描述）
- **一键应用**：将当前 Assembly 应用到战斗（PVE 验证）
- **指示器可预览**：编辑器可显示当前模板的指示器预览（线/扇/圆/突进路径），参考 Noita 的施法预览

## UI 结构（参考 Noita 的魔杖编辑界面）
**布局**：左侧编辑器，右侧战斗（或编辑器可折叠，战斗时收起）

**编辑器面板**：
- **技能描述**（新增）：一句话描述当前技能的核心能力（例如"向最近敌人发射快速穿透弹"）
  - 根据 Assembly 的 order 和 slotOptions 自动生成
  - 调整顺序或档位后实时更新
- **ECA 拼装可视化**（新增）：
  - 显示模块类型和执行顺序（C→T→A→TL）
  - 显示每个模块的档位选择
  - 用连线表示执行流程
- **模板选择**：Template 下拉（类似 Noita 的魔杖类型选择，当前为随机武器时显示"随机生成"）
- **模块链**：水平或垂直排列的模块卡片（参考 Noita 的法术槽位链）
  - **拖拽重排**：鼠标拖拽模块卡片调整顺序（参考 Noita）
  - **点击展开**：点击模块卡片展开档位选择（参考 Noita 的法术参数调整）
- **操作按钮**：
  - 应用到战斗（参考 Noita 的"装备魔杖"）
  - 重置默认
  - 刷新怪物（同时刷新随机武器）/ 暂停
  - 随机武器（可选，只刷新武器）
- **预览区**：
  - 施法体验摘要（前摇/弹速/范围）
  - 预算条（damage/cc/mobility/proc/perf）
  - 指示器预览（可选）
- **导出区**：Assembly JSON（调试用）

当前实现文件：
- 页面：`editor/index.html`
- 逻辑：`editor/play.js`

## 数据导出格式（建议）
建议导出两层：
1) **PlayerAssembly（玩家存档层）**：最小可持久化
```json
{
  "templateId": "tpl_ranged_proj_v1",
  "order": ["c1","t1","c2","a2","a3","a1","tl1"],
  "slotOptions": { "c1":"mana30", "t1":"coneW", "c2":"range18", "...":"..." },
  "description": "扇形范围发射穿透弹，可命中多个目标",
  "isRandom": true,
  "version": 1,
  "signature": "..."
}
```

2) **RuntimeIR（运行时层）**：服务端/战斗端执行用
- `ops[]`（每个 op 带 eval/exec/select 的映射在运行时生成）
- `guards`
- `budgets`

本项目当前 demo 为便捷，导出里直接展示了编译后的结构摘要（便于调试）。

## Signature（签名）与版本冻结（后续对接）
本阶段 demo 的 signature 是"弱签名"（仅用于示意）。上线形态建议：
- 保存时服务端将 `normalized(PlayerAssembly)` 做 hash，并用 server secret 签名
- 战斗端只接受签过的 assembly，避免客户端篡改

版本冻结建议：
- `templateId + templateVersion` 固定
- 若模板/档位/预算发生改动，生成新版本；旧版本只允许继续使用或做迁移

## 与随机武器系统的衔接
- **初始化**：`newWorld()` 或点击"刷新怪物"时，生成随机武器（随机模板 + 随机顺序 + 随机档位）
- **随机生成**：`generateRandomWeapon(templates, rng)` 返回随机 Assembly
- **编辑器加载**：随机生成的武器自动加载到编辑器，玩家可以在此基础上调整
- **描述生成**：每次 Assembly 变化时，调用 `generateSkillDescription(assembly)` 更新描述

## 与技能描述系统的衔接
- **描述生成**：`generateSkillDescription(assembly)` 根据 order 和 slotOptions 生成一句话描述
- **实时更新**：调整顺序或档位后，调用描述生成函数更新显示
- **可视化**：根据 order 渲染模块链可视化，显示类型和执行顺序

## 与 PVE 验证的衔接
编辑器"应用到战斗"的真实动作是：
- 重新 `compileAssembly(template, order, slotOptions)` 得到 `RuntimeIR`
- `EventBus` 替换当前 IR 订阅（下一次 CastConfirm/OnDamaged 即按新顺序生效）

## 与表现层的衔接（新增）
为保证"手感不漂"，推荐在 Template/Option 中同时携带最小表现参数（但仍由档位固定）：
- `windupMs` / `recoveryMs`
- `indicatorShape`（line/cone/circle/dash）
- `projectileSpeed`
- `sfxId` / `vfxId`

编辑器在展示 Assembly 时可同时显示"本次施法体验摘要"：前摇时长、指示器形状、弹速档位，帮助玩家理解顺序调整带来的变化（见 `07_表现层与手感设计.md`）。

## 启动方式（本地试玩）
通过本地静态服务器启动（见 `server.js` 与 `package.json` 的 `dev` 脚本），浏览器打开：
- `http://127.0.0.1:5173/`

若端口占用，可设置环境变量换端口：
```powershell
$env:PORT=5174
npm run dev
```
