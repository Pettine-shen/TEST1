# 模板选择规则优化

## 优化目标

解决随机武器生成重复度过高的问题，通过以下方式：
1. **扩展低多样性模板的选项**
2. **根据模板多样性调整选择权重**
3. **增强重复检测机制**

---

## 1. 模板选项扩展

### 1.1 tpl_melee_burst_v1（近战爆发模板）

**扩展前**：`c1` 槽位只有1个选项（range4）

**扩展后**：`c1` 槽位增加到3个选项
- `range4`（近战≤4m）
- `range3`（近战≤3m）
- `range5`（近战≤5m，增加伤害预算）

**组合数变化**：400种 → **1,200种**（提升3倍）

---

### 1.2 tpl_counter_v1（反击模板）

**扩展前**：`a1` 槽位只有1个选项（pulse）

**扩展后**：`a1` 槽位增加到4个选项
- `pulse`（3m脉冲）
- `pulse_small`（2m脉冲，伤害更高）
- `pulse_large`（4m脉冲，范围更大）
- `knockback_pulse`（击退脉冲，带击退效果）

**组合数变化**：128种 → **512种**（提升4倍）

---

### 1.3 tpl_ground_dot_v1（地面持续伤害模板）

**扩展前**：`c1` 槽位只有1个选项（mana25）

**扩展后**：`c1` 槽位增加到4个选项
- `mana25`（Mana≥25）
- `mana20`（Mana≥20）
- `mana30`（Mana≥30，增加伤害预算）
- `hp80`（HP≥80%）

**组合数变化**：16种 → **64种**（提升4倍）

---

### 1.4 tpl_mark_exec_v1（标记处决模板）

**扩展前**：
- `t1`：1个选项
- `a1`：1个选项
- `a2`：1个选项
- `tl1`：1个选项
- 总计：4种组合

**扩展后**：
- `t1`：增加到3个选项（single, lowestHp, nearest3）
- `a1`：增加到3个选项（mark, mark_vuln, mark_damage）
- `a2`：增加到3个选项（bonus, bonus_exp, bonus_heal）
- `tl1`：增加到3个选项（noDelay, delay200, delay400）

**组合数变化**：4种 → **162种**（提升40.5倍）

---

## 2. 模板选择权重优化

### 2.1 多样性权重系统

根据模板的基础组合数计算多样性权重：

| 组合数范围 | 多样性权重 | 说明 |
|----------|-----------|------|
| ≥100,000 | 1.0 | 极高多样性，正常权重 |
| ≥10,000 | 0.9 | 高多样性，略降权重 |
| ≥1,000 | 0.7 | 中等多样性，降低权重 |
| ≥100 | 0.4 | 低多样性，大幅降低权重 |
| ≥10 | 0.2 | 极低多样性，极低权重 |
| <10 | 0.1 | 几乎固定，极低权重 |

### 2.2 综合权重计算

**公式**：
```
最终权重 = 使用频率权重 × 多样性权重
```

**使用频率权重**：
- 最近使用3次以上：0.05
- 最近使用2次：0.3
- 最近使用1次：0.7
- 未使用过：1.0

### 2.3 优化后的模板权重示例

假设所有模板都未使用过：

| 模板ID | 组合数 | 多样性权重 | 最终权重 | 相对概率 |
|--------|--------|-----------|---------|---------|
| `tpl_ranged_proj_v1` | 316,800 | 1.0 | 1.0 | 47.6% |
| `tpl_melee_burst_v1` | 1,200 | 0.7 | 0.7 | 10.5% |
| `tpl_counter_v1` | 512 | 0.4 | 0.4 | 6.0% |
| `tpl_ground_dot_v1` | 64 | 0.2 | 0.2 | 3.0% |
| `tpl_mark_exec_v1` | 162 | 0.2 | 0.2 | 3.0% |

**效果**：低多样性模板的选择概率大幅降低，高多样性模板的选择概率提升。

---

## 3. 重复检测机制增强

### 3.1 分级重复检测

根据模板多样性，使用不同的检测范围：

| 模板多样性 | 选项组合检测范围 | 最终检测范围 | 重复阈值 |
|-----------|----------------|------------|---------|
| 高（≥100种） | 最近20次 | 最近50次 | `maxAttempts - 20/30` |
| 低（<100种） | 最近50次 | 最近100次 | `maxAttempts - 50` |

### 3.2 连续选择保护增强

**原规则**：连续3次选择同一模板时，强制选择其他模板。

**优化后**：连续3次选择同一模板时，优先从权重最高的3个其他模板中选择。

---

## 4. 优化效果预估

### 4.1 组合数提升

| 模板ID | 优化前组合数 | 优化后组合数 | 提升倍数 |
|--------|------------|------------|---------|
| `tpl_ranged_proj_v1` | 316,800 | 316,800 | 1.0x（无变化） |
| `tpl_melee_burst_v1` | 400 | 1,200 | 3.0x |
| `tpl_counter_v1` | 128 | 512 | 4.0x |
| `tpl_ground_dot_v1` | 16 | 64 | 4.0x |
| `tpl_mark_exec_v1` | 4 | 162 | 40.5x |

**总基础组合数**：317,348种 → **318,736种**（提升约0.4%）

虽然总组合数提升不大，但**低多样性模板的重复概率大幅降低**。

### 4.2 重复概率降低

**优化前**（假设每个模板被选中概率相等，20%）：
- `tpl_mark_exec_v1`：重复概率 = 25% × 20% = **5%**
- `tpl_ground_dot_v1`：重复概率 = 6.25% × 20% = **1.25%**

**优化后**（根据多样性权重）：
- `tpl_mark_exec_v1`：选择概率 ≈ 3%，组合数162种，重复概率 = 0.62% × 3% = **0.02%**
- `tpl_ground_dot_v1`：选择概率 ≈ 3%，组合数64种，重复概率 = 1.56% × 3% = **0.05%**

**重复概率降低约25-60倍**。

---

## 5. 实施细节

### 5.1 代码变更

1. **模板选项扩展**：`configs/templates.js`
   - 扩展了4个低多样性模板的选项

2. **模板选择规则**：`engine/randomWeapon.js`
   - 添加 `calculateTemplateCombinations()` 函数
   - 添加 `getDiversityWeight()` 函数
   - 修改模板选择权重计算逻辑

3. **重复检测增强**：`engine/randomWeapon.js`
   - 根据模板多样性调整检测范围
   - 增强连续选择保护机制

### 5.2 向后兼容性

- 所有变更都是**向后兼容**的
- 现有模板的选项ID保持不变
- 只是增加了新的选项，不影响现有功能

---

## 6. 后续优化建议

### 6.1 继续扩展选项

**优先级**：
1. **tpl_mark_exec_v1**：可以继续扩展 `a3` 槽位的选项
2. **tpl_ground_dot_v1**：可以扩展 `a1` 和 `a2` 槽位的选项
3. **tpl_counter_v1**：可以扩展 `a2` 和 `a3` 槽位的选项

### 6.2 增加新模板

**建议新增**：
- 持续伤害模板（DoT Chain）
- 控制链模板（CC Chain）
- 支援模板（Support）
- 位移模板（Mobility Focus）

### 6.3 动态权重调整

**未来可以考虑**：
- 根据实际游戏数据动态调整模板权重
- 根据玩家反馈调整低多样性模板的权重
- 实现模板使用频率的长期统计

---

## 7. 总结

通过本次优化：

1. **扩展了低多样性模板的选项**，组合数提升3-40倍
2. **引入了多样性权重系统**，低多样性模板的选择概率大幅降低
3. **增强了重复检测机制**，对低多样性模板使用更严格的检测

**预期效果**：
- 低多样性模板的重复概率降低**25-60倍**
- 整体重复概率降低**80%以上**
- 玩家体验的多样性大幅提升
